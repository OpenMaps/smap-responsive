var smap={core:{},event:$("<div />"),copyright:"© 2014 Malmö stad, Kristianstad kommun, Helsingborg stad, Lunds kommun"};
smap.core.Div=L.Class.extend({initialize:function(){this.parentTag=$("body"),this.draw()},draw:function(){var a=$("#mapdiv");if(!a.length){var a=$('<div id="mapdiv" class="mapdiv" />'),i=$('<div id="maindiv" class="maindiv" />');i.append(a),this.parentTag.append(i)}L.Browser.touch&&$(window).on("orientationchange",function(){window.scrollTo(0,0)}),smap.event.on("smap.core.pluginsadded",function(){($("body > header").length||smap.cmd.getControl("MalmoHeader"))&&i.addClass("map-with-header")})},CLASS_NAME:"smap.core.Div"});
smap.core.Init=L.Class.extend({_selectedFeatures:[],initialize:function(){this.defineProjs(),smap.core.divInst=new smap.core.Div,smap.cmd.loading(!0),this.init()},init:function(e){e=e||{};var n=this;this.drawMap(),smap.core.layerInst=new smap.core.Layer(this.map),smap.core.selectInst=new smap.core.Select(this.map),smap.core.paramInst=new smap.core.Param(this.map),smap.core.pluginHandlerInst=new smap.core.PluginHandler(this.map);var o=e.params||smap.core.paramInst.getParams();this.loadConfig(o.CONFIG).done(function(){function e(){smap.config.configName=o.CONFIG,smap.config.langCode=smap.cmd.getLang(),o=$.extend(utils.objectToUpperCase(smap.config.params||{}),o),n.applyConfig(smap.config),smap.core.paramInst.applyParams(o),smap.cmd.loading(!1)}if(smap.config=config||window.config,smap.config.onLoad){var a=smap.config.onLoad(smap.config);a.done(e)}else e()}).fail(function(e,n){utils.log("Config not loaded because: "+n),smap.cmd.loading(!1)})},applyConfig:function(e){this.preProcessConfig(e),$.extend(this.map.options,e.mapConfig||{}),this.map.options.maxBounds&&this.map.setMaxBounds(this.map.options.maxBounds),smap.core.pluginHandlerInst.addPlugins(e.plugins)},resetMap:function(){smap.map.off();for(var e=smap.core.controls,n=0,o=e.length;o>n;n++)try{smap.map.removeControl(e[n])}catch(a){}this.map.remove(),this.map=null,delete this.map,smap.map=null,delete smap.map,window.config=null;try{delete window.config}catch(a){}smap.config=null,delete smap.config,smap.event.off(),smap.core.controls=[],smap.core.layerInst=null,smap.core.modInst=null,smap.core.paramInst=null,delete smap.core.layerInst,delete smap.core.modInst,delete smap.core.paramInst},drawMap:function(e){e=e||{},L.Browser.touch&&L.Browser.ie&&(e.tapTolerance=30);var n=smap.core.mainConfig.mapConfig||{},o=$.extend(n,e);this.map=L.map("mapdiv",o),smap.map=this.map,o.disabledRightClick&&this.map.on("contextmenu",function(e){e.originalEvent.preventDefault(),e.originalEvent.stopPropagation()}),utils.getBrowser().ie9&&$(".leaflet-bottom.leaflet-right").addClass(".leaflet-bottom-right-ie9")},loadConfig:function(e){return e=e||"config.js",-1===e.search(/\//g)&&(e=document.URL.split("?")[0].search("dev.html")>-1?"dist/configs/"+e:"configs/"+e),$.ajax({url:e,context:this,dataType:"script"})},preProcessConfig:function(e){e.ws&&e.ws.hasOwnProperty(document.domain)&&(e.ws=e.ws[document.domain]);for(var n=e.bl||[],o=0,a=n.length;a>o;o++)n[o].options=n[o].options||{},n[o].options.isBaseLayer=!0;for(var s,t=e.bl.concat(e.ol||[]),i=this._createLegendUrl,o=0,a=t.length;a>o;o++)s=t[o],void 0===s.options.legend&&s.options.layers&&_.indexOf(["L.TileLayer.WMS","L.NonTiledLayer.WMS"],s.init)>-1&&(s.options.legend=i(s.url,s.options.layers))},_createLegendUrl:function(e,n){n.split(",").length>1&&(n=n.split(",")[0]);var o="request=GetLegendGraphic&format=image/png&width=20&height=20&layer="+n;return utils.urlAppend(e,o)},defineProjs:function(){window.proj4&&(proj4=window.proj4,proj4.defs([["EPSG:4326","+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"],["EPSG:3857","+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"],["EPSG:3008","+proj=tmerc +lat_0=0 +lon_0=13.5 +k=1 +x_0=150000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"],["EPSG:3006","+proj=utm +zone=33 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"],["EPSG:3021","+proj=tmerc +lat_0=0 +lon_0=15.8062845294444 +k=1.00000561024+x_0=1500064.274 +y_0=-667.711 +ellps=GRS80 +units=m"]]))},CLASS_NAME:"smap.core.Init"});
smap.core.Layer=L.Class.extend({options:{defaultStyle:{color:"#00F",fillColor:"#00F",opacity:1,fillOpacity:.3,radius:8,weight:1},selectStyle:{weight:5,color:"#00DDFF",dashArray:"",fillOpacity:.8,strokeOpacity:1}},_layers:{},_bindEvents:function(){var e=this.map;this._onLayerAdd=this._onLayerAdd||$.proxy(this.onLayerAdd,this),this._onLayerRemove=this._onLayerRemove||$.proxy(this.onLayerRemove,this),e.on("layeradd",this._onLayerAdd),e.on("layerremove",this._onLayerRemove),smap.event.on("smap.core.applyparams",$.proxy(function(t,a){var r;if(r=a.BL?smap.cmd.getLayerConfig(a.BL):smap.config.bl[0],r&&r.options&&(r.options.isBaseLayer=!0,e.addLayer(this._createLayer(r))),a.OL){var i,n=a.OL instanceof Array?a.OL:a.OL.split(",");for(i=0,len=n.length;len>i;i++)this._addLayerWithConfig(smap.cmd.getLayerConfig(n[i]))}},this))},initialize:function(e){this.map=e,this._bindEvents()},addOverlays:function(e){this._addLayers(e)},_addLayers:function(e){e=e||[];var t,a;for(t=0,len=e.length;len>t;t++)a=e[t],this._addLayerWithConfig(a)},_addLayerWithConfig:function(e){if(!e||!e.options)return!1;var t=this._createLayer(e);return t?(this.map.addLayer(t),t):!1},onLayerAdd:function(e){var t=e.layer;if(t.options&&!t.options._silent&&t.options.layerId&&!t.feature&&(t instanceof L.NonTiledLayer||t._tileContainer||t._layers)){var a=t.options.layerId;this._layers[a]=t,t._layers&&this._wfsLayers.push(t)}},onLayerRemove:function(e){var t=e.layer;t._layers&&this._wfsLayers.splice(t,1)},_getLayer:function(e){return this._layers[e]||null},_wfsLayers:[],_createLayer:function(t){var layerAlreadyAdded=this._getLayer(t.options.layerId);if(layerAlreadyAdded)return layerAlreadyAdded;var init=eval(t.init);init.options=init.options||{},t.options.zIndex=t.options.isBaseLayer?t.options.zIndex||0:t.options.zIndex||10;var layer;if(t.params)layer=Object.create(init.prototype),init.apply(layer,t.params),t.options&&t.options instanceof Object&&$.extend(layer.options,t.options);else{if(t.url){var opts=t.options;if(init===L.TileLayer.WMS){var newOpts=$.extend(!0,{},opts);newOpts=_.pick(newOpts,["service","request","version","layers","styles","format","transparent","width","height","bbox","angle","buffer","cql_filter","env","featureid","filter","format_options","maxfeatures","namespace","palette","propertyname","tiled","tilesorigin","scalemethod"]),layer=new init(t.url,newOpts),$.extend(layer.options,opts),layer.setZIndex(opts.zIndex)}else layer=new init(t.url,opts)}else t.key?(layer=new init(t.key,t.options),layer.options.layerid=t.options.layerId,this._layers[t.options.layerId]=layer):layer=new init(t.options);layer instanceof L.esri.DynamicMapLayer&&(this._layers[t.options.layerId]=layer)}var self=this;return layer._layers?(layer.options.style=!layer.options.style&&layer.options.geomType&&layer.options.geomType.search(/POINT/gi)>-1?null:layer.options.style||$.extend({},self.options.defaultStyle),layer.on("loadcancel loaderror",function(){smap.cmd.loading(!1)})):layer.on("load",function(){smap.cmd.loading(!1)}),layer.on&&(layer.on("load",function(){smap.cmd.loading(!1)}),layer.on("loading",function(){smap.cmd.loading(!0)})),layer},showLayer:function(e){var t=e instanceof Object?e:smap.cmd.getLayerConfig(e),a=this._getLayer(e);return a||(a=this._createLayer(t)),this.map.hasLayer(a)===!1&&this.map.addLayer(a),a},hideLayer:function(e){var t=this._getLayer(e);t.fire&&t.fire("loadcancel",{layer:this}),this.map.removeLayer(t)},CLASS_NAME:"smap.core.Layer"});
smap.core.Param=L.Class.extend({initialize:function(a){this.map=a},_lang:{sv:{remove:"Ta bort"},en:{remove:"Remove"}},_setLang:function(){langCode=smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[langCode]:null)},getParams:function(){if(!this._cachedParams){var a="?",t=location.href.split(a),e=t.length>1?t[1]:"";this._cachedParams=utils.paramsStringToObject(e,!0)}return this._cachedParams},createParamsAsObject:function(){var a,t,e,n=this.map.getCenter(),r=this.map._layers,s=[];for(var o in r)t=r[o],t&&t.options&&t.options.layerId&&(e=t.options.layerId,t.options.isBaseLayer?a=e:-1===$.inArray(t.options.layerId,s)&&s.push(e));var i={zoom:this.map.getZoom(),center:[utils.round(n.lng,5),utils.round(n.lat,5)],ol:s,bl:a};return smap.config.configName&&(i.config=smap.config.configName),smap.event.trigger("smap.core.createparams",i),i},createParams:function(a){a=a||!1;var t,e=this.createParamsAsObject(),n="";for(var r in e){if(t=e[r],t instanceof Array){if(!t.length)continue;t=t.join(",")}n+="&"+r+"="+t}return n=n.substring(1),a===!0&&(n=document.URL.split("?")[0]+"?"+n),n},applyParams:function(a){a=a||{};var t=this;this._setLang();var e=a.ZOOM?parseInt(a.ZOOM):0,n=a.CENTER?L.latLng([parseFloat(a.CENTER[1]),parseFloat(a.CENTER[0])]):null;if(e||0===e||(e=this.map.options.minZoom||0),n?this.map.setView(n,e,{animate:!1}):this.map.fitWorld(),a.XY){var r=L.marker(L.latLng(parseFloat(a.XY[1]),parseFloat(a.XY[0])));if(this.map.addLayer(r),a.XY.length>2){var s="<p>"+a.XY[2]+'</p><button class="btn btn-default smap-core-btn-popup">'+this.lang.remove+"</button>";r.bindPopup(s).openPopup(),$(".smap-core-btn-popup").on("click",function(){t.map.removeLayer(r)})}}smap.event.trigger("smap.core.applyparams",a)},CLASS_NAME:"smap.core.Param"});
smap.core.PluginHandler=L.Class.extend({initialize:function(n){this.map=n;var t=this;smap.event.on("smap.core.pluginsadded",function(){t._processQueue()})},getPlugin:function(){for(var n,t=smap.core.controls||[],i=0,e=t.length;e>i;i++)if(n=t[i],n instanceof L.Control[controlName])return n;return null},addPlugins:function(arr){var t,init,autoActivates=[];smap.core.controls=smap.core.controls||[];for(var i=0,len=arr.length;len>i;i++)t=arr[i],init=eval(t.init),init&&(init=new init(t.options||{}),this.map.addControl(init),smap.core.controls.push(init),init.options.autoActivate&&autoActivates.push(init));smap.event.trigger("smap.core.pluginsadded"),smap.event.pluginsadded=!0;for(var i=0,len=autoActivates.length;len>i;i++)autoActivates[i].activate()},_callQueue:[],callPlugin:function(n,t,i,e){i=i||[];var a=L.Control[n];smap.event.pluginsadded?this._callPlugin(a,t,i,e):this._callQueue.push([a,t,i,e])},_callPlugin:function(n,t,i,e){if(!n)return null;for(var a,l=smap.core.controls||[],r=null,o=0,s=l.length;s>o;o++)if(a=l[o],a instanceof n){r=a[t].apply(a,i||[]);break}return e?e(r):r},_processQueue:function(){var n,t,i,e=this._callQueue||[];for(t=0,len=e.length;len>t;t++)n=e[t],i=this._callPlugin.apply(this,n);return this._callQueue=[],i},CLASS_NAME:"smap.core.PluginHandler"});
smap.core.Select=L.Class.extend({options:{manyUseDialog:!0},_selectedFeaturesVector:[],_selectedFeaturesWms:[],initialize:function(e){this.map=e,this._bindEvents(e),this._wfsLayers=smap.core.layerInst._wfsLayers},_getVectorVal:function(e,t){var r,e=e||{};if(paramVal=null,t.split(";").length>1){var a=t.split(";");r=e[a[0]]+";"+e[a[1]]}else r=e[t];return r},_setSelectStyle:function(e){var t=e.target;t.setStyle&&t.setStyle(this.options.selectStyle),!t.bringToFront||L.Browser.ie||L.Browser.opera||t.bringToFront()},_resetStyle:function(e){e.resetStyle&&e.eachLayer(function(t){e.resetStyle(t)})},_processHtml:function(e){var t=$("<div>"+e+"</div>");return t.find(".popup-divider:last").remove(),t.find("a").each(function(){var e=$(this),t=e.attr("href"),r=e.text();if(t&&t.length>=4&&-1===$.inArray(t,["null","undefined"])){"HTTP"!==t.substring(0,4).toUpperCase()&&(t="http://"+t);var a=$('<button class="btn btn-default btn-sm">'+r+"</button>");a.attr("onclick",'window.open("'+t+'", "_blank")'),e.after(a)}e.remove()}),t.html()},_extractAllAttributes:function(e,t){t=t||{};var r="",a="<div><strong>_key_:</strong>&nbsp;<span>_val_</span></div>";for(var o in t)r+=a.replace(/_key_/g,o).replace(/_val_/g,"${"+o+"}");var s="*";return e.search(/\$\{\*\}/)>-1&&(s=/\$\{\*\}/g),e.replace(s,r)},_bindEvents:function(e){var t=this;e.on("layerremove",function(){t._rasterFeature&&(e.removeLayer(t._rasterFeature),t._rasterFeature=null)}),e.on("click",function(){for(var r=t._wfsLayers,a=0,o=r.length;o>a;a++)t._resetStyle(r[a]);e.fire("unselected",{})}),e.on("unselected",function(e){t._rasterFeature&&(t.map.removeLayer(t._rasterFeature),t._rasterFeature=null),e.feature?$.each(t._selectedFeaturesVector,function(r,a){return e.feature.id===a.id?(t._selectedFeaturesVector.splice(r,1),!1):void 0}):(t._selectedFeaturesVector=[],t._selectedFeaturesWms=[])}),e.on("selected",function(r){function a(e,t,r,a){a=a||!1;var o="";a&&(o+="leaflet-popup-option leaflet-popup-option-short");var s="";return s+='<div class="'+o+'"><h4 class="popup-layertitle">'+r+"</h4>",s+=utils.extractToHtml(e,t)+"</div>",s+='<div class="popup-divider"></div>'}function o(){t._rasterFeature&&(t._rasterFeature.resetStyle(),t.map.removeLayer(t._rasterFeature),t._rasterFeature=null)}function s(e){return o(),e.geometry.type&&"Point"!==e.geometry.type&&"MultiPoint"!==e.geometry.type&&(t._rasterFeature=L.geoJson(e.geometry),t._rasterFeature.options=$.extend({},e.options),t._rasterFeature.options._silent=!0,t._rasterFeature.latLng=e.latLng,t._rasterFeature.setStyle({color:"#0FF",fillColor:"#0FF",weight:10,opacity:.9,fillOpacity:.3}),t._rasterFeature.options.selectable=!1,t._rasterFeature.eachLayer(function(e){e.eachLayer&&e.eachLayer(function(e){e.options.clickable=!1}),e.options&&(e.options.clickable=!1)}),t.map.addLayer(t._rasterFeature)),t._rasterFeature}function n(){var e=$(this).data("index"),r=t._selectedFeaturesWms[e];s(r);var o=L.popup(),n=a(r.options.popup,r.properties,r.options.displayName);if(n=t._processHtml(n),o.setContent(n),t._rasterFeature&&t._rasterFeature.getBounds){var l=t._rasterFeature.getBounds(),p=l.getCenter();o.setLatLng(p)}else o.setLatLng(r.latLng);return o.openOn(t.map),$(this).trigger("mouseenter"),t._selectManyModal.modal("hide"),!1}function l(){var e=$(this).data("index");if(e||0===e){var r=t._selectedFeaturesWms[e];s(r)}return $(this).siblings().addClass("leaflet-popup-option-short"),$(this).removeClass("leaflet-popup-option-short"),!1}var p=r.layer,i=p.hasOwnProperty("_layers")||p.options&&p.options.clickable,u=(p.options.layerId,r.feature),c=r.selectedFeatures||[],d=(p.options.uniqueKey||"-",r.shiftKeyWasPressed),f=u.properties,_=r.latLng;if(i?(t._selectedFeaturesWms=[],d?(t._selectedFeaturesVector=utils.makeUniqueArr(t._selectedFeaturesVector.concat(c)),$.each(t._wfsLayers,function(e,t){t.eachLayer(function(e){e.unbindPopup&&e.unbindPopup(),e._layers&&$.each(e._layers,function(e,t){t.unbindPopup&&t.unbindPopup()})})})):t._selectedFeaturesVector=[].concat(c)):(t._selectedFeaturesVector=[],t._selectedFeaturesWms=utils.makeUniqueArr(t._selectedFeaturesWms.concat(c))),i&&!d&&t._selectedFeaturesVector.length<=1){for(var m,y=t._wfsLayers,h=0,g=y.length;g>h;h++)m=y[h],m!==p&&(m.resetStyle&&m.resetStyle(m),m._selectedFeatures=[]);var v=p.options.popup;(p.options.popup&&"*"===p.options.popup||p.options.popup.search(/\$\{\*\}/)>-1)&&(v=t._extractAllAttributes(v,f));var F=utils.extractToHtml(v,f);F=t._processHtml(F);var m=utils.getLayerFromFeature(u,p)||u;m._popup&&m.unbindPopup(),m.bindPopup(F,{autoPan:!0,keepInView:!1,autoPanPadding:L.point(0,70)}),m._popup&&m._map&&m.openPopup(_)}if(!i){for(var b,f,v,F="",h=0,g=c.length;g>h;h++)b=c[h],f=b.properties,v=b.options.popup,(v&&"*"===v||v.search(/\$\{\*\}/)>-1)&&(v=t._extractAllAttributes(v,f)),F=a(v,b.properties,b.options.displayName,!0);F=t._processHtml(F),e.closePopup();var M=L.popup(),k=$("<div />").append(F);if(1===t._selectedFeaturesWms.length)s(b),k.find(".leaflet-popup-option").removeClass("leaflet-popup-option leaflet-popup-option-short");else{if(t.options.manyUseDialog){if(!t._selectManyModal){var f,w,P=$('<button type="button" class="btn btn-default">Stäng</button>'),S=$('<div class="list-group"></div>');P.on("tap click",function(){return o(),t._selectManyModal.modal("hide"),!1}),t._selectManyModal=utils.drawDialog("Flera träffar: Välj ett objekt",S,P,{size:"sm"}),t._selectManyModal.find(".modal-header").addClass("panel-heading"),t._selectManyModal.on("hidden.bs.modal",function(){$(this).find(".list-group").empty()}),t._selectManyModal.on("shown.bs.modal",function(){$(this).scrollTop(0)}),t._selectManyModal.addClass("core-select-modal")}for(var V,x,C=t._selectManyModal.find(".list-group"),h=0,g=c.length;g>h;h++)V=c[h],f=V.properties,x=utils.extractToHtml(V.options.popup,f),(x&&"*"===x||x.search(/\$\{\*\}/)>-1)&&(x=t._extractAllAttributes(x,f)),x=t._processHtml(x),w=$('<a href="#" class="list-group-item"><span><strong>'+V.options.displayName+"</strong>"+x+'</span><div class="btn btn-success select-btn-zoom-to-feature">Zooma hit</div></a>'),w.data("index",h),L.Browser.touch&&w.addClass("select-row-touch"),C.append(w);var W=C.find(".list-group-item");return W.find(".select-btn-zoom-to-feature").on("touchend click",function(){if(n.call($(this).parent()[0]),t._rasterFeature){var e=t._rasterFeature.getBounds(),r=L.Browser.touch?[100,100]:[200,150];t.map.fitBounds(e,{paddingTopLeft:r,paddingBottomRight:[100,100]})}else{var a=($(this).parent().data("index"),15);a=t.map.getZoom()<a?a:t.map.getZoom()+1,t.map.setZoomAround(b.latLng,a)}return t._selectManyModal.modal("hide"),!1}),L.Browser.touch?W.on("tap",function(){var e=$(this).data("index"),r=t._selectedFeaturesWms[e];return s(r),n.call(this),!1}):W.on("click",n),t._selectManyModal.modal("show"),!0}t._onPopupOpen=t._onPopupOpen||function(){$(".leaflet-popup-content-wrapper").addClass("leaflet-popup-content-wrapper-multichoice"),$(".leaflet-popup-content .leaflet-popup-option").each(function(e){var t=$(this);t.data("index",e)}),$(".leaflet-popup-content .leaflet-popup-option").addClass("leaflet-popup-option-short").on("click",l),$(".leaflet-popup-content .leaflet-popup-option:first").click(),e.off("popupopen",t._onPopupOpen)},e.on("popupopen",t._onPopupOpen),t._selectedFeaturesWms.length>3&&(M.options.autoPan=!1)}M.setContent(k.html()),M.setLatLng(b.latLng),setTimeout(function(){var t=smap.cmd.getControl("SelectWMS");return t&&t._dblclickWasRegistered===!0?!1:void M.openOn(e)},100)}}),smap.event.on("smap.core.createparams",function(e,r){function a(e,t,r){e&&(l[e]||(l[e]={}),l[e][t]||(l[e][t]=[]),l[e][t].push(r))}var o,s,n,l={};if(t._selectedFeaturesVector&&t._selectedFeaturesVector.length){n=t._selectedFeaturesVector;for(var p=0,i=n.length;i>p;p++)o=n[p],o.properties&&o.uniqueKey&&(s=t._getVectorVal(o.properties,o.uniqueKey),a(o.layerId,"vals",s),l[o.layerId].key=o.uniqueKey)}if(t._selectedFeaturesWms&&t._selectedFeaturesWms.length){n=t._selectedFeaturesWms;for(var p=0,i=n.length;i>p;p++)o=n[p],s=[o.latLng.lng,o.latLng.lat],a(o.options.layerId,"xy",s)}$.isEmptyObject(l)===!1&&(r.sel=encodeURIComponent(JSON.stringify(l)))}),smap.event.on("smap.core.applyparams",$.proxy(function(e,t){function r(){var e,t,o,s,p,i,u=this,c=this.options.layerId,d=this.options.uniqueKey,f=n[c],_=f.vals;for(o=0,len=_.length;len>o;o++)t=_[o],e=null,$.each(u._layers,function(r,a){if(a.feature){if(s=a.feature.properties,d.split(";").length>1?(p=d.split(";"),i=s[p[0]]+";"+s[p[1]]):i=a.feature.properties[d],!i)return!1;if(i===t)return e=a,!1}}),e&&e.fire("click",{properties:e.feature.properties,latlng:a,originalEvent:{shiftKey:l}});u.off("load",r)}if(t.SEL){var a,o,s,n=JSON.parse(decodeURIComponent(t.SEL)),l=!1,p=0;for(var i in n)if(p+=1,p>1||n[i].vals&&n[i].vals.length>1){l=!0;break}for(s in n)o=n[s],o.key&&smap.core.layerInst.showLayer(s).on("load",r)}}))}});
smap.cmd={createParams:function(a){return smap.core.paramInst.createParams(a)},createParamsAsObject:function(){return smap.core.paramInst.createParamsAsObject()},getControl:function(a){var e=this.getControls(a);return e.length?e[0]:null},getControls:function(a){a.search(/\./)>-1&&(a=a.split(".").slice(2).join("."));for(var e,t=smap.core.controls||[],r=[],n=0,o=t.length;o>n;n++)e=t[n],e instanceof L.Control[a]&&r.push(e);return r},notify:function(a,e,t){switch(t=t||{},t.parent=t.parent||$("body"),e){case"success":e="alert-success";break;case"warning":e="alert-danger";break;case"error":e="alert-danger"}var r=$('<div class="alert map-alert '+e+' alert-dismissable"> <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'+a+"</div>");return t.parent.find(".alert").remove(),t.parent.append(r),r},addLayerWithConfig:function(a){return smap.core.layerInst._addLayerWithConfig(a)},getLayer:function(a){return smap.core.layerInst._getLayer(a)},getLayerConfig:function(a){return this.getLayerConfigBy("layerId",a)},getLayerConfigBy:function(key,val,options){options=options||{};var arr=smap.config.bl.concat(smap.config.ol||[]),i,t,compVal;for(i=0,len=arr.length;len>i;i++){if(t=arr[i],-1!==key.search(/\./))try{compVal=eval("t."+key)}catch(e){continue}else compVal=t.options[key];if(options.inText){if(void 0!==compVal&&compVal.search(val)>-1)return t}else if(void 0!==compVal&&compVal===val)return t}return null},getLang:function(){var a=smap.core.paramInst?smap.core.paramInst.getParams().LANG||navigator.language:"sv",e=a?a.split("-")[0]:"sv";return e},reloadCore:function(a){a=a||{},smap.core.initInst.resetMap(),smap.core.initInst.init(a)},loading:function(a){var e={sv:{loading:"Laddar…"},en:{loading:"Loading…"}},t=this.getLang(),r=e.hasOwnProperty(t)?e[t]:e.en;a&&a===!0?(this.loader||(this.loader=$('<div class="loader"><span class="fa fa-spinner"></span><label>'+r.loading+"</label></div>")),$("#mapdiv").append(this.loader)):this.loader.detach()}};
smap.core.mainConfig={mapConfig:{layers:[],crs:L.CRS.EPSG3857,attributionControl:!0,zoomControl:!1,maxZoom:18,disabledRightClick:!0},toolbarPlugin:"Menu",defaultTheme:"smap",configFolders:["/rest/leaf/configs-1.0/"]};
var utils={rmPx:function(t){return parseInt(t.replace(/px/gi,"").replace(/em/gi,"").replace(/pt/gi,""))},log:function(){window.console},capitalize:function(t){return t.charAt(0).toUpperCase()+t.slice(1)},getBrowser:function(){var t=navigator.userAgent.match(/(?:MSIE |Trident\/.*; rv:)(\d+)/),e=t?parseInt(t[1]):void 0;return{ie8:8===e,ie9:9===e,ie10:10===e,ie11:11===e}},urlAppend:function(t,e,r){r=r||"?";var n="?"===r?/\?/g:/#/g,a=e.charAt(e.length-1);return"&"===a&&(t=a.substring(0,e.length-1)),-1===t.search(n)&&(t+=r),t+e},isInIframe:function(){return top.location!=self.location},makeUniqueArr:function(t){var e=[];return $.each(t,function(t,r){-1===$.inArray(r,e)&&e.push(r)}),e},objectToUpperCase:function(t){var e={};for(var r in t)e[r.toUpperCase()]=t[r];return e},drawDialog:function(t,e,r,n){n=n||{},n.size=n.size||"";var a=$('<div class="modal fade"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>'+(-1===t.search(/</g)?'<h4 class="modal-title">'+t+"</h4>":t)+'</div><div class="modal-body"></div></div>');if(a.find(".modal-body").append(e),r){var i=$('<div class="modal-footer"></div>');a.find(".modal-body").after(i),i.append(r)}return n.size&&a.find(".modal-dialog").addClass("modal-"+n.size),a},getLayerFromFeature:function(t,e){var r=e._layers;for(var n in r){var a=r[n];if(a.feature&&a.feature.id===t.id)return a}return null},round:function(t,e){var r=Math.pow(10,e||0);return Math.round(t*r)/r},makeUnselectable:function(t){t.attr("unselectable","unselectable").addClass("unselectable")},extractToHtml:function(html,props){function getFunctionEnd(t){var e=1,r=!1,n=t.search(/\{/g);t=t.substring(n+1);var a=0;for(a=0,len=t.length;len>a;a++)if("{"===t.charAt(a)?e+=1:"}"===t.charAt(a)&&(e-=1),0===e){r=!0,a=a+n+2;break}return r||(a=-1),a}function extractAttribute(a,txt){var index=txt.search(/\${/g);if(-1!==index){var extractedAttribute="",attr=html.substring(index+2),endIndex=0;if(endIndex="function"===attr.substring(0,8)?getFunctionEnd(attr):attr.search(/\}/g),attr=attr.substring(0,endIndex),"function"===attr.substring(0,8)){var theFunc=attr.replace("function","function f");eval(theFunc),extractedAttribute=f.call(this,a)}else extractedAttribute=a[attr]||"";txt=txt.replace("${"+attr+"}",extractedAttribute)}return txt}if(!props)return"";if("undefined"==typeof html)return html=null;for(var index=html.search(/\${/g);-1!==index;)html=extractAttribute(props,html),index=html.search(/\${/g);return html},createLabel:function(t,e,r){r=r||"leaflet-maplabel";var n=L.marker(t,{icon:new L.DivIcon({iconSize:null,className:r,html:"<div>"+e+"</div>"})});return n.options._noprint=!0,n.options.clickable=!1,n.options.selectable=!1,n},getLength:function(t){var e,r=0;for(e=0,len=t.length-1;len>e;e++)r+=t[e].distanceTo(t[e+1]);return r},paramsStringToObject:function(t,e){e=e||!1;for(var r,n,a,i={},o=t.split(/[&;]/),s=0,c=o.length;c>s;s++)if(a=o[s].split("="),a[0]){r=a[0];try{r=decodeURIComponent(r)}catch(l){r=unescape(r)}n=(a[1]||"").replace(/\+/g," ");try{n=decodeURIComponent(n)}catch(l){n=unescape(n)}n=n.split(","),1==n.length&&(n=n[0]),e&&(r=r.toUpperCase()),i[r]=n}return i},projectPoint:function(t,e,r,n){return window.proj4(r,n,[t,e])},projectLatLng:function(t,e,r,n,a){var i=n?[t.lat,t.lng]:[t.lng,t.lat],o=window.proj4(e,r,i),s=a?L.latLng(o[0],o[1]):L.latLng(o[1],o[0]);return s},projectFeature:function(t,e,r){function n(t,e){return d(t[0],t[1],e,"EPSG:4326")}function a(t){return t=[t[1],t[0]]}r=r||{};var i,o,s,c,l,d=this.projectPoint;switch(l=t.geometry,l.type){case"Point":i=l.coordinates,r.reverseAxis&&(i=this.swapCoords(i)),s=n(i,e),l.coordinates=s;break;case"MultiPoint":for(c=0,f=l.coordinates.length;f>c;c++)i=l.coordinates[c],r.reverseAxis&&(i=this.swapCoords(i)),s=n(i,e);break;case"LineString":for(o=l.coordinates[0],c=0,lenP=o.length;lenP>c;c++)i=o[c],r.reverseAxis&&(i=this.swapCoords(i)),s=n(i,e),o[c]=s;break;case"MultiLineString":o=[];var u,f,p;for(c=0,f=l.coordinates.length;f>c;c++){for(o=l.coordinates[c],u=0,p=o.length;p>u;u++)i=o[u],r.reverseAxis&&(i=a(i)),s=n(i,e),o[u]=s;l.coordinates[c]=o}break;case"Polygon":for(o=l.coordinates[0],c=0,lenP=o.length;lenP>c;c++)i=o[c],r.reverseAxis&&(i=this.swapCoords(i)),s=n(i,e),o[c]=s;break;case"MultiPolygon":o=[];var u,h,f,p,g,v;for(c=0,f=l.coordinates.length;f>c;c++)for(o=l.coordinates[c],u=0,p=o.length;p>u;u++)for(v=o[u],h=0,g=v.length;g>h;h++)i=v[h],r.reverseAxis&&(i=a(i)),s=n(i,e),v[h]=s}}};
L.Control.Add2HomeScreen=L.Control.extend({options:{},initialize:function(n){L.setOptions(this,n),$("body").append('<script src="lib/add-to-homescreen/src/addtohomescreen.js"></script>')},onAdd:function(n){return this.map=n,this._container=L.DomUtil.create("div","leaflet-control-add2HomeScreen"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._container},onRemove:function(){}}),L.control.add2HomeScreen=function(n){return new L.Control.Add2HomeScreen(n)};
L.Control.DrawSmap=L.Control.extend({options:{buttons:{polyline:{addToPopover:!0,iconCss:"fa icon-large icon-vector-path-line",displayName:"Polyline",iconClass:"drawBtns"},polygon:{addToPopover:!0,iconCss:"fa icon-large icon-vector-path-polygon",displayName:"Polygon",iconClass:"drawBtns",showArea:!0},rectangle:{addToPopover:!0,iconCss:"fa icon-large icon-vector-path-square",displayName:"Rectangle",iconClass:"drawBtns"},circle:{addToPopover:!0,iconCss:"fa icon-large icon-vector-path-circle",displayName:"Circle",iconClass:"drawBtns"},marker:{addToPopover:!0,iconCss:" fa icon-large icon-map-marker",displayName:"Marker",iconClass:"drawBtns"},edit:{addToPopover:!0,iconCss:"fa fa-edit",displayName:"Edit",iconClass:""},remove:{addToPopover:!0,iconCss:"fa fa-times",displayName:"Remove",iconClass:""},save:{addToPopover:!0,iconCss:"fa icon-large icon-map-save",displayName:"Save",iconClass:""}}},_lang:{sv:{caption:"rita",close:"Stäng",btntitle:"rita",lineTitle:"Rita en linje.",lineStart:"Klicka i kartan för att börja rita en linje.",lineCont:"Rita linje",lineEnd:"Rita linje",polylineTooltip:"hej",polygonTitle:"Rita figur",rectangleTitle:"Rita linje",circleTitle:"Rita cirkel",markerTitle:"Markör",editTooltip:"Ändra genom att dra i brytpunkter, eller markör.",rmDisabledTitle:"Inget att radera.",rmEnabledTitle:"Radera figur(er).",rmTooltip:"Klicka på en figur för att ta bort den."},en:{caption:"draw",close:"Close",btntitle:"Draw",lineTitle:"Draw a line.",polygonTitle:"Draw a polygon.",rectangleTitle:"Draw a rectangle.",circleTitle:"Draw a circle.",circleTooltip:"Click and drag to draw a circle.",markerTitle:"Draw a marker.",markerTooltip:"Click map to place a marker.",editDisabledTitle:"Nothing to edit.",editEnabledTitle:"Edit object(s).",editTooltip:"Drag handles, or marker, to edit objects.",editTooltipSub:"Click cancel-button to undo changes.",editSaveTxt:"Save it!",editSaveTooltip:"Save ur changes",editCancelTxt:"Cancel",editCancelTooltip:"Cancel this!",rmDisabledTitle:"Nothing to delete.",rmEnabledTitle:"Delete object(s).",rmTooltip:"Click an object to delete it."}},_setLang:function(e){e=e||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[e]:null)},initialize:function(e){L.setOptions(this,e),this._setLang(e.langCode)},setTexts:function(){var e=L.drawLocal,t=this.lang;e.draw.toolbar.buttons.polyline=t.lineTitle,e.draw.toolbar.buttons.polygon=t.polygonTitle,e.draw.toolbar.buttons.rectangle=t.rectangleTitle,e.draw.toolbar.buttons.circle=t.circleTitle,e.draw.handlers.circle.tooltip.start=t.circleTooltip,e.draw.toolbar.buttons.marker=t.markerTitle,e.draw.handlers.marker.tooltip.start=t.markerTooltip,e.edit.toolbar.buttons.editDisabled=t.editDisabledTitle,e.edit.toolbar.buttons.edit=t.editEnabledTitle,e.edit.handlers.edit.tooltip.text=t.editTooltip,e.edit.handlers.edit.tooltip.subtext=t.editTooltipSub,e.edit.toolbar.actions.save.text=t.editSaveTxt,e.edit.toolbar.actions.save.title=t.editSaveTooltip,e.edit.toolbar.actions.cancel.text=t.editCancelTxt,e.edit.toolbar.actions.cancel.title=t.editCancelTooltip,e.edit.toolbar.buttons.removeDisabled=t.rmDisabledTitle,e.edit.toolbar.buttons.remove=t.rmEnabledTitle,e.edit.handlers.remove.tooltip.text=t.rmTooltip},onAdd:function(){var e=this;return e._drawcontainer=L.DomUtil.create("div","leaflet-control-drawsmap"),L.DomEvent.disableClickPropagation(e._drawcontainer),e.$drawcontainer=$(e._drawcontainer),e.initDone=!1,e.currentTool={},e.initDraw(e.$drawcontainer),e._drawcontainer},activate:function(){},initDraw:function(e){var t=this;return t.featureGroup=L.featureGroup().addTo(smap.map),t.drawControl=new L.Control.Draw({position:"bottomright",draw:{marker:!1,polyline:!1,polygon:!1,rectangle:!1,circle:!1},edit:{edit:!1,remove:!1,featureGroup:t.featureGroup,selectedPathoptions:{maintainColor:!0,opacity:.3}}}),t.setTexts(),smap.map.on("draw:created",function(e){var a=(e.layerType,e.layer);t.bindLabelNotify(e),a.on("click",function(){return 1==t.delModeOn&&(t.featureGroup.removeLayer(a),t.featureGroup.getLayers().length||($("#drawsmapremove").prop("disabled",!0),$("#drawsmapedit").prop("disabled",!0),t.currentTool.disable(),t.currentTool={},t.delModeOn=!1)),!1}),t.featureGroup.addLayer(a),$("#drawsmapremove").prop("disabled",!1),$("#drawsmapedit").prop("disabled",!1),t.currentTool={}}),smap.map.on("draw:edited",function(){}),smap.map.on("draw:editstop",function(){t.bindLabelNotify(this)}),$.each(t.options.buttons,function(a,o){if(o.addToPopover===!0){var i=t._createToolBtn(a,o);e.append(i)}}),e},hideNotify:function(){var e=$(".notifyjs-container").is(":visible");e&&$(".notifyjs-container").parent().remove()},bindLabelNotify:function(e){var t=this;if("marker"===e.layerType){t.hideNotify();var a=e.layer._latlng,o=e.layer.bindLabel(""+a,{noHide:!1});o.on("click",function(){t.hideNotify(),t.showResults(a)}),t.showHideLbl(o),t.showResults(a)}if("circle"===e.layerType){t.hideNotify();var a=e.layer._mRadius.toFixed(2),o=e.layer.bindLabel(""+a,{noHide:!0});o.on("click",function(){t.hideNotify(),t.showResults("Radius: "+a)}),t.showHideLbl(o),t.showResults("Radius: "+a)}if("rectangle"===e.layerType){t.hideNotify();var i=e.layer._latlngs[0],r=e.layer._latlngs[1],n=i.distanceTo(r),l=e.layer._latlngs[2],s=e.layer._latlngs[3],d=l.distanceTo(s),c=(n*d).toFixed(2),o=e.layer.bindLabel(""+c,{noHide:!0});o.on("click",function(){t.hideNotify(),t.showResults("Area: "+c)}),t.showHideLbl(o),t.showResults("Area: "+c)}if("polygon"===e.layerType&&t.hideNotify(),"polyline"===e.layerType||"edit"===e.handler){t.hideNotify();var a=(L.polyline(e.layer._latlngs),utils.getLength(e.layer._latlngs));t.showResults(a);var o=e.layer.bindLabel(""+a,{noHide:!0});o.on("click",function(){t.hideNotify(),t.showResults(a)}),t.showHideLbl(o)}},showHideLbl:function(e){e.on("mouseover",function(){var e=$(".leaflet-draw-tooltip").is(":visible");e&&$(".leaflet-draw-tooltip").hide()},this).on("mouseout",function(){$(".leaflet-draw-tooltip").show()},this)},showResults:function(e){$.notify.addStyle("happywhite",{html:'<div><span data-notify-text/><button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button></div>',classes:{base:{"white-space":"nowrap","background-color":"#fff",padding:"15px",width:"auto",height:"auto","font-size":"16px"},superblue:{color:"#000","background-color":"#fff"}}}),$.notify(""+e,{position:"b c",style:"happywhite",clickToHide:!1,autoHide:!1})},_createToolBtn:function(e,t){var a=this;e.toLowerCase();var o=$('<button id="drawsmap'+e+'" class="btn btn-default '+t.iconClass+' " title="'+t.displayName+'"><span></span></button>');switch(e=e.charAt(0).toUpperCase()+e.slice(1)){case"Polyline":var i=new L.Draw.Polyline(smap.map,a.drawControl.options.draw.polyline);break;case"Polygon":var i=new L.Draw.Polygon(smap.map,a.drawControl.options.polygon);break;case"Rectangle":var i=new L.Draw.Rectangle(smap.map,a.drawControl.options.rectangle);break;case"Circle":var i=new L.Draw.Circle(smap.map,a.drawControl.options.circle);break;case"Marker":var i=new L.Draw.Marker(smap.map,a.drawControl.options.marker);break;case"Edit":var i=new L.EditToolbar.Edit(smap.map,{featureGroup:a.drawControl.options.edit.featureGroup,selectedPathOptions:a.drawControl.options.edit.selectedPathOptions});a.featureGroup.getLayers().length||o.prop("disabled",!0);break;case"Remove":var i=new L.EditToolbar.Delete(smap.map,{featureGroup:a.drawControl.options.edit.featureGroup});a.featureGroup.getLayers().length||o.prop("disabled",!0);break;case"Save":break;default:return}return o.on("click",function(){1==i.enabled()?(i.disable(),a.currentTool={},a.delModeOn=!1):("remove"==a.currentTool.type?a.delModeOn=!1:"",1==$.isEmptyObject(a.currentTool)?a.currentTool=i:a.currentTool.disable(),i.enable(),"remove"==i.type?a.delModeOn=!0:"",a.currentTool=i)}),o.find("span").addClass(t.iconCss),o},_createDrawTool:function(){var e=this,t=$('<button id="smap-drawsmap-btn" title="'+e.lang.btntitle+'" class="btn btn-default"><span ></span><i class="fa fa-th"></i></button>');e.$drawcontainer.append(t),t.on("click",function(){var t=$(this);return t.data("bs.popover")?$(".drawsmap-popover").is(":visible")?$(".drawsmap-popover").hide():$(".drawsmap-popover").show():(t.popover({placement:"bottom",container:"body",title:e.lang.popoverTitle,trigger:"manual"}),t.on("shown.bs.popover",function(){if(!e.initDone){var t=$(".popover"),a=$(".popover-content");t.addClass("drawsmap-popover"),a.attr("id","drawsmap-popover"),e.initDraw(a),e.initDone=!0}}),t.on("hidden.bs.popover",function(){}),t.popover("show")),!1})},onRemove:function(){}}),L.control.drawsmap=function(e){return new L.Control.DrawSmap(e)};
L.Control.Editor=L.Control.extend({options:{position:"bottomright",useProxy:!1,reverseAxis:!1},_lang:{sv:{dTitle:"Objektets attribut",close:"Avbryt",save:"Spara",remove:"Ta bort",move:"Flytta",editProps:"Ändra",moveLP:"Ändra geometri",editPropsLP:"Ändra attribut",ruSureRemove:"Ta bort objektet? Åtgärden kan inte ångras.",saveNewMarker:"Spara",saveMove:"Spara",undo:"Ångra",cancel:"Avbryt"},en:{dTitle:"Object attributes",close:"Cancel",save:"Save",remove:"Remove",move:"Move",editProps:"Edit",moveLP:"Edit geometry",editPropsLP:"Edit attributes",doYouWantTo:"Do you want to",cannotBeUndoed:"Cannot be undoed",ruSureRemove:"Remove feature? Cannot be undoed.",saveNewMarker:"Save",saveMove:"Save",undo:"Undo",cancel:"Cancel"}},_geomTypes:{POINT:"marker",MULTIPOINT:"marker",LINESTRING:"polyline",MULTILINESTRING:"polyline",POLYGON:"polygon",MULTIPOLYGON:"polygon"},_geomType:"marker",_setLang:function(e){e=e||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[e]:null)},initialize:function(e){L.setOptions(this,e),this._setLang(e.langCode),this._inserts=[],this._updates=[],this._deletes=[]},onAdd:function(e){this.map=e,this._container=L.DomUtil.create("div","leaflet-control-editor"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._drawModal();var t=this;return smap.event.on("smap.core.pluginsadded",function(){t._setEditableLayer()}),this._container},onRemove:function(){},_addBtnAdd:function(){var e=this,t=$(".smap-editor-btnadd");if(!t.length){var t=$('<button class="btn btn-default btn-lg smap-editor-btnadd"><i class="glyphicon glyphicon-plus"></i></button>');$(".leaflet-top.leaflet-left").prepend(t),t.on("click",function(){var t=e._getDrawToolbar();return $(this).toggleClass("btn-danger"),$(this).hasClass("btn-danger")?t.handler.enable():t.handler.disable(),!1})}},_setEditableLayer:function(){function e(){if($(this).parent().hasClass("list-group-item-danger"))n.stopEditing();else{var e=$(this).data("t")||{};"L.GeoJSON.WFS"===e.init&&n.startEditing(e,$(this).parent())}return!1}var t,a,r,i=smap.config.ol||[],o=smap.cmd.getControl("LayerSwitcher");if(!o)return!1;for(var n=this,s=0,d=i.length;d>s;s++)t=i[s],r=$('<i class="fa fa-edit smap-editor-switcher-icon"></i>'),t.options.isEditable&&(a=$("#"+o._makeId(t.options.layerId)),a.append(r),r.data("t",t),r.on("click",e))},_disabledRowClick:function(e){return e.stopPropagation(),e.preventDefault(),$(e.target).tooltip("show"),setTimeout(function(){$(e.target).tooltip("hide")},2e3),!1},stopEditing:function(){if(this._editLayer){this._editLayer.options.editable=!1;var e=this._editLayer.options.layerId,t=e.substring(0,e.length-"-edit".length),a=smap.cmd.getLayer(t);a&&a.clearLayers&&a.clearLayers(),a&&a._refresh&&a._refresh(!0),this.map.removeLayer(this._editLayer)}return $(".lswitch-panel-ol .list-group-item").off("click",this._disabledRowClick).removeClass("list-group-item-danger"),$(".lswitch-panel-ol .list-group-item").tooltip("destroy"),this.map.off("draw:created"),this.map.off("popupopen",this.__onPopupOpen),$(".smap-editor-btnadd").remove(),!0},_validateConfig:function(e){e=e||{};var t=e.options||{},a=[];for(var r in this._geomTypes)a.push(r);return t.geomType?-1===$.inArray(t.geomType.toUpperCase(),a)?!1:!0:!1},startEditing:function(e,t){function a(e){var t=e.layer.jsonData.features||[];if(t.length)r.options.geomType=r._geomType=r._geomTypes[e.layer.options.geomType.toUpperCase()],!r._geomType;else{var a=e.layer.options.geomType;a&&(r._geomType=r._geomTypes[a.toUpperCase()])}}var r=this,i=this.map;if(this.stopEditing()!==!0)return!1;if(this._addBtnAdd(),$(".lswitch-panel-ol .list-group-item.active").trigger("tap"),$(".lswitch-panel-ol .list-group-item-danger").removeClass("list-group-item-danger"),$(".lswitch-panel-ol .list-group-item").tooltip({title:"Redigering är aktiv. Deaktivera redigering för att tända lagret.",trigger:"manual",placement:"right",container:"#maindiv"}).on("click",this._disabledRowClick),t.addClass("list-group-item-danger"),this._validateConfig(e)===!1)return!1;var o=$.extend({},e.options),n=o.params.typeName;o.url=e.url,o.featureNS=n.split(":")[0],o.featureType=n.split(":")[1],o.layerId=o.layerId+"-edit";var s=o.geomType.toUpperCase(),d="POINT"===s?this.lang.move:this.lang.moveLP,l="POINT"===s?this.lang.editProps:this.lang.editPropsLP,p=this.lang.remove;o.popup='${*}<div class="popup-divider"></div><div style="white-space:nowrap;min-width:25em;" class="btn-group btn-group-sm editor-popup-edit"><button id="editor-popup-edit" type="button" class="btn btn-default">'+l+'</button><button id="editor-popup-move" type="button" class="btn btn-default">'+d+'</button><button id="editor-popup-remove" type="button" class="btn btn-default">'+p+"</button></div>",this._editLayer=L.wfst(e.url,o),this._editLayer.on("wfst:savesuccess",function(){smap.cmd.loading(!1)}),this._editLayer.on("wfst:saveerror",function(){smap.cmd.loading(!1)}),this._editLayer.on("wfst:ajaxerror",function(){smap.cmd.loading(!1)}),i.addLayer(this._editLayer),this._drawControl=new L.Control.Draw({edit:{featureGroup:this._editLayer}}),i.addControl(this._drawControl),$(".leaflet-draw").remove(),this._editLayer.on("load",a),i.on("draw:created",function(e){$(".smap-editor-btnadd").removeClass("btn-danger"),r._editLayer.addLayer(e.layer),r._marker=e.layer,r._showSaveToolbar("insert")}),this.__onPopupOpen=this.__onPopupOpen||$.proxy(this._onPopupOpen,this),this.map.on("popupopen",this.__onPopupOpen)},_getLayerById:function(e,t){function a(o){var n=o._layers||{};if(!n)return null;if(n.hasOwnProperty(t))return{marker:n[t],markerGeometry:n[t]};var s,d;for(d in n)if(0===i&&(r=d),i+=1,s=a(n[d]),i-=1,s)return{marker:e._layers[r],markerGeometry:s.marker};return null}var r,i=0;return a(e)},_onPopupOpen:function(e){var t=this;if(this._marker&&this._marker.dragging&&this._marker.dragging._draggable&&this._marker.dragging._draggable._enabled){if(this.map.closePopup(),confirm("Do you to stop editing this feature? Any changes made to the feature will be removed.")!==!0)return;this.cancelEdit()}var a=$(e.popup._container);if(e.popup._source.feature&&"polyline"!=this._geomType)this._marker=e.popup._source,this._markerGeometry=null;else{var r=this._getLayerById(this._editLayer,e.popup._source._leaflet_id);this._marker=r.marker,this._markerGeometry=e.popup._source}a.find("#editor-popup-remove").on("click",function(){return confirm(t.lang.ruSureRemove)===!0&&t._editLayer.wfstRemove(t._marker).done(function(){t._editLayer.clearLayers(),t._editLayer._refresh(!0)}),!1}),a.find("#editor-popup-move").on("click",function(){t.map.closePopup();var e=t._getEditToolbar();return e.handler._enableLayerEdit(t._markerGeometry||t._marker),t._showSaveToolbar("update"),t._editLayer.options.editable=!0,!1}),a.find("#editor-popup-edit").on("click",function(){return t._modalEdit.modal("show"),!1})},_getEditToolbar:function(){var e;for(var t in this._drawControl._toolbars)if(e=this._drawControl._toolbars[t],e&&e._modes&&e._modes.edit)return e._modes.edit;return null},_getDrawToolbar:function(){var e;for(var t in this._drawControl._toolbars)if(e=this._drawControl._toolbars[t],e&&e._modes&&e._modes[this._geomType])return e._modes[this._geomType];return null},wfstSave:function(e){e=e?L.Util.isArray(e)?e:[e]:[];var t,a,r=[],i=this._editLayer;for(a=0,len=e.length;len>a;a++)if("object"==typeof e[a]._layers)for(t in e[a]._layers)smap.cmd.loading(!0),r.push(i._wfstSave(e[a]._layers[t]));else r.push(i._wfstSave(e[a]));return $.when.apply($,r)},save:function(e){e=e||null;var t,a,r=this._inserts,i=this._updates,o=this._editLayer,n=r.length;for(t=0;n>t;t++)a=r[t],o._wfstAdd(a).done(function(){r.splice(a,1),e&&e()});for(n=i.length,t=0;n>t;t++)a=i[t],this.wfstSave(a).done(function(){i.splice(a,1)})},cancelEdit:function(){var e=this._getEditToolbar();e.handler._disableLayerEdit(this._markerGeometry||this._marker),this._editLayer.clearLayers(),this._editLayer._refresh(!0),this._hideSaveToolbar()},_showSaveToolbar:function(e){if(this._editType=e,!this._saveToolbar){var t=this;this._saveToolbar=$('<div class="smap-editor-savetoolbar btn-group btn-group-lg" />');var a=$('<button class="btn btn-success">Save</button>'),r=$('<button class="btn btn-default">Cancel</button>');this._saveToolbar.append(r).append(a),$(".leaflet-top.leaflet-left").append(this._saveToolbar),a.on("click",function(){if(t._marker.options.geomType=t._editLayer.options.geomType.toUpperCase(),"update"===t._editType){var e=t._marker.options.geomType;"POINT"===e||"POLYGON"===e?t.wfstSave(t._marker):(t._markerGeometry.feature=$.extend({},t._marker.feature),t.wfstSave(t._markerGeometry))}var a=t._getEditToolbar();return a.handler._disableLayerEdit(t._markerGeometry||t._marker),"insert"===t._editType?(t._inserts.push(t._marker),t.save(function(){t._editLayer.clearLayers(),t._editLayer._refresh(!0),t._hideSaveToolbar()})):"update"===t._editType&&(t.save(),t._hideSaveToolbar()),!1}),r.on("click",function(){return t.cancelEdit(),!1})}var i="insert"==this._editType?this.lang.saveNewMarker:this.lang.saveMove,o=this.lang.cancel;this._saveToolbar.find("button:eq(0)").text(o),this._saveToolbar.find("button:eq(1)").text(i),this._saveToolbar.show()},_hideSaveToolbar:function(){this._saveToolbar.hide()},_fillModal:function(e){if(e=e||null,null===e)return!1;var t,a,r,i,o=this._modalEdit.find("#smap-editor-content"),n=$('<form role="form" />');for(t in e)"fid"!==t&&"id"!==t&&"gid"!==t&&(a=e[t],i="smap-editor-propentry-"+t,r='<div class="form-group">					<label for="'+i+'">'+t+'</label>					<input type="text" name="'+t+'" class="form-control" id="'+i+'" value="'+(a||"")+'">				</div>',n.append(r));n.find("input").on("change",function(){$(this).addClass("changed")}),o.append(n)},_onSaveAttributesSuccess:function(){this._marker.fire("click")},_saveAttributes:function(){var e=this._marker.feature.properties,t={},a=this._modalEdit.find("form").find("input.changed");if(!a.length)return this._modalEdit.modal("hide"),!1;a.each(function(){t[$(this).attr("name")]=$(this).val()});var r=$.extend({},e,t);this._marker.feature.properties=r,this._marker.toGML||(this._markerGeometry.feature=$.extend({},this._marker.feature)),this.__onSaveAttributesSuccess=this.__onSaveAttributesSuccess||$.proxy(this._onSaveAttributesSuccess,this),this._editLayer.off("wfst:savesuccess",this.__onSaveAttributesSuccess).on("wfst:savesuccess",this.__onSaveAttributesSuccess),this._editLayer._wfstSave(this._markerGeometry||this._marker,{newProps:t}),this._modalEdit.modal("hide"),this.map.closePopup()},_drawModal:function(){var e=this,t=$('<div id="smap-editor-content" />'),a='<button type="button" class="btn btn-default" data-dismiss="modal">'+this.lang.close+'</button><button id="smap-editor-editmodal-btnsave" type="button" class="btn btn-primary">'+this.lang.save+"</button>";this._modalEdit=utils.drawDialog(this.lang.dTitle,t,a,{}),this._modalEdit.find("#smap-editor-editmodal-btnsave").on("click",function(){return e._saveAttributes(),!1}),this._modalEdit.on("shown.bs.modal",function(){var t=e._marker.feature.properties;e._fillModal(t),e._modalEdit.on("keypress",function(t){13===t.which&&($("#smap-editor-editmodal-btnsave").focus(),e._saveAttributes(),e._modalEdit.modal("hide"),t.preventDefault())})}),e._modalEdit.on("hidden.bs.modal",function(){t.empty(),e._modalEdit.off("keypress")})}});
L.Control.FullScreen=L.Control.extend({options:{position:"topright"},_lang:{sv:{btnExpand:"Visa i fullskärm",btnCompress:"Återställ"},en:{btnExpand:"Show in fullscreen",btnCompress:"Reset"}},_setLang:function(n){n=n||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[n]:null)},initialize:function(n){L.setOptions(this,n),this._setLang(n.langCode)},onAdd:function(n){this.map=n;var t=this;return this._container=L.DomUtil.create("div","leaflet-control-fullScreen"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._createBtn(),screenfull.enabled&&document.addEventListener(screenfull.raw.fullscreenchange,function(){t._updateButton()}),this._container},activate:function(){var n=document.getElementById("body");screenfull.enabled&&screenfull.toggle(n)},_updateButton:function(){var n=this,t=$("#smap-fullscreen-btn");screenfull.isFullscreen?(t.find("span").addClass("fa-compress"),t.attr("title",n.lang.btnCompress)):(t.find("span").removeClass("fa-compress"),t.attr("title",n.lang.btnExpand))},onRemove:function(){},_createBtn:function(){var n=this;this.$btn=$('<button id="smap-fullscreen-btn" title="'+n.lang.btnExpand+'" class="btn btn-default"><span class="fa fa-expand"></span></button>'),this.$btn.on("click",function(){return n.activate(),!1}),this.$container.append(this.$btn)}}),L.control.fullScreen=function(n){return new L.Control.FullScreen(n)};
L.Control.Geolocate=L.Control.extend({options:{position:"bottomright",locateOptions:{maxZoom:17,enableHighAccuracy:!0}},_lang:{sv:{errorGeolocate:"Kunde inte hitta din position",notSupported:"Din webbläsare stödjer inte geolokalisering"},en:{errorGeolocate:"The browser could not detect your position",notSupported:"Your browser does not support geolocation"}},_setLang:function(t){t=t||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-Geolocate"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._drawButton(),this._container},onRemove:function(){},_drawButton:function(){var t=$('<button id="smap-glocate-btn" class="btn btn-default"><span class="fa fa-location-arrow"></span></button>');this.$container.append(t),this.btn=t,t.on("click",$.proxy(function(){return this.active?this.deactivate():this.activate(),!1},this))},activate:function(){return this.active?!1:navigator.geolocation?(this.active=!0,this.btn.addClass("btn-primary"),smap.cmd.loading(!0),this.__onLocationFound=this.__onLocationFound||$.proxy(this._onLocationFound,this),this.__onLocationError=this.__onLocationError||$.proxy(this._onLocationError,this),this.__onDragStart=this.__onDragStart||$.proxy(this._onDragStart,this),this.map.on("locationfound",this.__onLocationFound),this.map.on("locationerror",this.__onLocationError),this.map.on("dragstart",this.__onDragStart),this.map.on("zoomstart",this.__onDragStart),void this._startLocate(this.options.locateOptions)):(smap.cmd.notify(this.lang.notSupported),!1)},deactivate:function(){return this.active?(this.active=!1,smap.cmd.loading(!1),this.btn.removeClass("btn-primary"),this.map.off("locationfound",this.__onLocationFound),this.map.off("locationerror",this.__onLocationError),this.map.off("dragstart",this.__onDragStart),this.map.off("zoomstart",this.__onDragStart),this._stopLocate(),void(this.marker&&(this.map.removeLayer(this.marker),this.marker=null))):!1},_startLocate:function(t){t=t||{};var o={watch:!0,setView:!0,enableHighAccuracy:!1};t=$.extend(o,t),this.map.locate(t)},_stopLocate:function(){this.map.stopLocate()},_onLocationFound:function(t){smap.cmd.loading(!1),this.marker=this.marker||L.userMarker(t.latlng,{pulsing:!0}).addTo(this.map),this.marker.setLatLng(t.latlng),this.marker.setAccuracy(t.accuracy)},_onLocationError:function(t){smap.cmd.loading(!1);var o=smap.cmd.notify(this.lang.errorGeolocate+": "+t.message,"error",{parent:$("body")});o.on("touchstart",function(){$("body").find(".alert").remove()}),this.deactivate()},_onDragStart:function(){this._stopLocate(),this._startLocate({setView:!1})}}),L.control.geolocate=function(t){return new L.Control.Geolocate(t)};
L.Control.GuideIntroScreen=L.Control.extend({options:{autoActivate:!0,position:"bottomright",prefix:'<a href="//leafletjs.com" title="A JS library for interactive maps">Leaflet</a>',bgSrc:null,langs:{sv:"Svenska",en:"English"},words:{sv:{btnStartTour:"Starta turen"},en:{btnStartTour:"Start the tour"}},header:{sv:{title:"Promenadstaden",subHeaders:["Malmö museer, Science Center"]},en:{title:"The walking city",subHeaders:["Malmö museums, Science Center"]}},configs:[{configName:"guide-industri.js",disabledText:!1,sv:{title:"Industristaden",description:"Industrispåret guidar dig genom de gamla industrierna i Malmös innerstad."},en:{title:"The industrial city",description:"This tour guides you to some old industrial buildings of Malmö"}},{configName:"guide-vh.js",disabledText:!1,sv:{title:"Västra hamnen",description:"Västra hamnen guidar dig genom Malmös modernaste och fräsigaste stadsdel."},en:{title:"Western harbor",description:"This tour guides you through the most modern part of Malmö."}}]},initialize:function(t){L.setOptions(this,t)},onAdd:function(t){this.map=t,this._container=L.DomUtil.create("div","leaflet-control-guideintroscreen"),L.DomEvent.disableClickPropagation(this._container);var n=this._makeContent("sv"),i=$('<div class="guide-introscreen" />');return i.append(n),this.options.euLogoSrc&&i.append('<img class="gintro-eulogo" src="'+this.options.euLogoSrc+'"></img>'),this.options.bgSrc&&i.prepend('<img class="gintro-bg gintro-bg-left" src="'+this.options.bgSrc+'"></img><img class="gintro-bg gintro-bg-right" src="'+this.options.bgSrc+'"></img>'),this.$container=i,this._container},onRemove:function(){this.deactivate(),this.$container.remove()},activate:function(){$("#maindiv").append(this.$container),$("#mapdiv").hide()},deactivate:function(){this.$container.detach(),$("#mapdiv").show()},_makeContent:function(t){for(var n=$('<div class="guide-content container" />'),i=this.options.words[t],e=this,o=function(){smap.cmd.loading(!0);var t=$(this).data("configName");return smap.map.removeControl(e),smap.cmd.reloadCore({params:{CONFIG:t}}),!1},s=this.options.header[t],a="",r=0,d=s.subHeaders.length;d>r;r++)a+='<p class="lead">'+s.subHeaders[r]+"</p>";var l=$('<div class="container" id="gintro-logo-container"></div>');this.options.munLogoSrc&&l.append('<img class="gintro-munlogo" src="'+this.options.munLogoSrc+'"></img>');var c,g='<div class="container"><h1 style="margin-bottom:20px;">'+s.title+"</h1>"+a+"</div>",p="btn-danger",u=this.options.langs,m="",h=$('<div style="margin-top:30px;" class="btn-group" />');for(var b in u)m=u[b],c=$('<button type="button" class="guideintro-btn-option btn btn-default">'+m+"</button>"),b===t&&c.addClass(p),c.data("langCode",b),h.append(c);n.append(g),l.children().length&&n.append(l),n.append(h);var v,f,C,S,x=this.options.configs,L=$('<div class="row" />');n.append(L);for(var r=0,d=x.length;d>r;r++){if(v=x[r],S=v.configName,f=v[t],C=$('<div class="gintro-box col-xs-6 col-md-4 col-lg-3 text-left"><h3>'+f.title+'</h3><div style="margin-bottom:20px;"><p class="lead text-muted">'+f.description+'</p><button class="btn btn-default btn-sm gintro-btn-configoption">'+i.btnStartTour+"</button></div></div>"),v.disabledText){var T=$('<div class="gintro-disbox"><label>'+v.disabledText+"</label></div>");C.find("div").append(T),C.find("button").addClass("disabled"),C.addClass("disabled")}C.addClass("col-xs-offset-3 col-md-offset-1 col-lg-offset-1");var y=C.find("button");y.data("configName",S),L.append(C)}return n.find(".guideintro-btn-option").on("click",function(){var n=$(this).data("langCode");if(t!==n){$(this).addClass(p).siblings().removeClass(p).addClass("btn-default");var i=e._makeContent(n).children();$(".guide-content").empty().append(i)}return!1}),n.find(".gintro-btn-configoption").on("click",o),n}}),L.control.guideIntroScreen=function(t){return new L.Control.GuideIntroScreen(t)};
L.Control.GuidePopup=L.Control.extend({options:{},initialize:function(t){L.setOptions(this,t),this._setLang()},_lang:{sv:{introHeader:"Info",mediaHeader:"Media",accessHeader:"Tillgänglighet",close:"Stäng",showMore:"Visa mer"},en:{introHeader:"About",mediaHeader:"Media",accessHeader:"Accessibility",close:"Close",showMore:"Read more"}},_setLang:function(t){t=t||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this.lang=this._lang?this._lang[t]:null)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-guidepopup"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this.__onPopupClick=this.__onPopupClick||$.proxy(this._onPopupClick,this),this._activate(),this._container},onRemove:function(){this._deactivate(),950>windowWidth?this.hideTheTag():this.showTheTag()},_onPopupClick:function(t){var e=$("#gp-btn-show").data("props"),i=this._getFeatureData(e[this.options.attrId]),o=i.tabMedia,a=i.tabIntro;if(a)this.createPopup(e);else if(o&&o instanceof Object){var n,s=this._makeMediaContent(o.mediaType,utils.extractToHtml(o.sources,e).split(","));"image"!==i.mediaType&&(n=utils.extractToHtml(i.fullScreenIntroPic,e)),this.showFullScreen(s,utils.extractToHtml(o.label,e),n)}return($(t.target).hasClass("gp-mediaicons")||$(t.target).parent().hasClass("gp-mediaicons"))&&$('[href="#gp-moreinfo"]').click(),!1},_onPopupOpen:function(t){if(t.popup._source&&t.popup._source.feature){var e=t.popup._source.feature.layerId;if(e!==this.options.layerId)return;var i=t.popup._source.feature.properties;t.popup.options.autoPanPaddingTopLeft=[0,60],$(".leaflet-popup-content").find(".gp-mediaicons").on("touchstart click",this.__onPopupClick);var o=this._getFeatureData(i[this.options.attrId]);if(o&&o instanceof Object){var a=$('<button style="margin-top:10px;" id="gp-btn-show" class="btn btn-default">'+this.lang.showMore+"</button>");$(".leaflet-popup-content").append(a),a.data("props",i),a.on("touchstart click",this.__onPopupClick)}}},_onPopupClose:function(t){$(t.popup._wrapper).off("touchstart",this.onPopupClick)},_activate:function(){var t=this,e={audio:{icon:L.icon({iconUrl:"img/glyphish-icons/PNG-icons/120-headphones.png",iconSize:[22,21],iconAnchor:[11,10],popupAnchor:[0,-8]})},video:{icon:L.icon({iconUrl:"img/glyphish-icons/PNG-icons/46-movie-2.png",iconSize:[20,25],iconAnchor:[10,12],popupAnchor:[0,-9]})},image:{icon:L.icon({iconUrl:"img/glyphish-icons/PNG-icons/121-landscape.png",iconSize:[22,21],iconAnchor:[11,10],popupAnchor:[0,-8]})}},i=smap.cmd.getLayerConfig(this.options.layerId);i.options.pointToLayer=function(i,o){{var a=i.properties||{},n=t.options.modalContentOverrides[a[t.options.attrId]]||{};n.tabMedia}return n.iconType&&e[n.iconType]?L.marker(o,e[n.iconType]):L.marker(o)};smap.cmd.addLayerWithConfig(i);this.__onPopupOpen=this.__onPopupOpen||$.proxy(this._onPopupOpen,this),this.__onPopupClose=this.__onPopupClose||$.proxy(this._onPopupClose,this),this.map.on("popupopen",this.__onPopupOpen),this.map.on("popupclose",this.__onPopupClose)},_deactivate:function(){this.map.off("popupopen",this.__onPopupOpen),this.map.off("popupclose",this.__onPopupClose)},_makeCarousel:function(t){t=t||[];for(var e,i=$('<div id="guide-carousel" class="carousel slide">'),o=$('<ol class="carousel-indicators" />'),a=$('<div class="carousel-inner" />'),n=$('<a class="left carousel-control" href="#guide-carousel" data-slide="prev"><span class="icon-prev"></span></a><a class="right carousel-control" href="#guide-carousel" data-slide="next"><span class="icon-next"></span></a>'),s=0,p=t.length;p>s;s++)e=t[s],o.append('<li data-target="#guide-carousel" data-slide-to="'+s+'"></li>'),a.append('<div class="item"><img src="'+e+'"></img></div>');return a.find(".item:first").add(o.find("li:first")).addClass("active"),i.append(o).append(a).append(n),i.swiperight(function(){$(this).carousel("prev")}).swipeleft(function(){$(this).carousel("next")}),$(document).on("orientationchange",function(){var t=window.innerHeight;$(".gp-fullscreen").height(t)}),i},_makeAudioTag:function(t){t=t||[];for(var e,i,o,a,n=$('<audio controls="controls" />'),s=0,p=t.length;p>s;s++){switch(e=t[s],i=e.substring(e.length-3).toUpperCase()){case"OGG":o="audio/ogg";break;case"MP3":o="audio/mpeg"}a='<source src="'+e+'" type="'+o+'" />',n.append(a)}return n},_makeVideoTag:function(t){t=t||[];var e=$(window).width()-2,i=$(window).height()-65;if(i>e){var o=e;e=i,i=o}i/=2,e/=2;var a,n=t[0];return n.search(/youtu.be|youtube/i)>-1?a=$('<iframe src="'+n+'?rel=0" width="100%" height="80%" frameborder="0" allowfullscreen></iframe>'):n.search(/vimeo.com/i)&&(a=$('<iframe src="'+n+'" width="100%" height="80%" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>')),a},_makeAccessContent:function(t){var e=this._getFeatureData(t[this.options.attrId]);return utils.extractToHtml(e.tabAccess,t)},_makeMediaList:function(t,e){if(t=t||[],!t.length)return null;var i,o,a,n={image:"fa fa-picture-o fa-lg",audio:"fa fa-volume-up fa-lg",video:"fa fa-film fa-lg"},s=$('<div id="gp-listmoreinfo" class="list-group" />');for(o=0,len=t.length;len>o;o++)i=t[o],(!i.condition||i.condition&&i.condition(e)===!0)&&(a=$('<a href="#" class="list-group-item"><span class="'+n[i.mediaType]+'"></span>&nbsp;&nbsp;&nbsp;'+utils.extractToHtml(i.label,e)+"</a>"),s.append(a));return s.children().length?s:null},showFullScreen:function(t,e,i){function o(t){27===t.which&&a()}function a(){return $("body").off("keydown",o),$(".gp-fullscreen").removeClass("gp-fs-visible"),$(".gp-fullscreen").find("audio").each(function(){this.pause&&this.pause()}),setTimeout(function(){$(".gp-fullscreen").empty().remove()},500),!1}var n=$('<div class="gp-fullscreen"></div>');$("body").on("keydown",o);var s=$('<button type="button" class="btn btn-default">Stäng</button>');s.on("click",function(){return a(),!1});var p="<h1>"+e+"</h1>";if(n.append(p),i){var r=$('<img class="gp-mediapic" src="'+i+'" />');n.append(r)}n.append(t),n.append(s),s.css("z-index",3e3),$("body").append(n),setTimeout(function(){n.addClass("gp-fs-visible")},1)},_makeMediaContent:function(t,e){switch(t.toLowerCase()){case"image":content=this._makeCarousel(e);break;case"audio":content=this._makeAudioTag(e);break;case"video":content=this._makeVideoTag(e)}return content},_getFeatureData:function(t){var e=this.options.modalContentOverrides[t]||{};return $.extend(!0,{},this.options.modalContent||{},e)},createPopup:function(t){function e(){var e,o=$(this).index(),n=a.tabMedia[o],s=utils.extractToHtml(n.sources,t),p=i._makeMediaContent(n.mediaType,s.split(","));return"audio"===n.mediaType&&(e=utils.extractToHtml(a.fullScreenIntroPic,t)),i.showFullScreen(p,$(this).text(),e),!1}t=t||{};var i=this,o='<ul class="nav nav-tabs"><li class="active"><a href="#gp-intro" data-toggle="tab">'+this.lang.introHeader+'</a></li><li><a href="#gp-moreinfo" data-toggle="tab">'+this.lang.mediaHeader+'</a></li><li><a href="#gp-access" data-toggle="tab">'+this.lang.accessHeader+'</a></li></ul><div class="tab-content gp-popup"><div class="tab-pane active" id="gp-intro"></div><div class="tab-pane" id="gp-moreinfo"></div><div class="tab-pane" id="gp-access"></div></div>';o=$(o);var a=this._getFeatureData(t[this.options.attrId]),n=this._makeMediaList(a.tabMedia,t);n?o.find("#gp-moreinfo").append(n):o.find('[href="#gp-moreinfo"], #gp-moreinfo').remove();var s=this._makeAccessContent(t);s?o.find("#gp-access").append(s):o.find('[href="#gp-access"], #gp-access').remove();var p=utils.extractToHtml(a.dialogTitle||t[this.options.dialogTitle],t),r='<button type="button" class="btn btn-default" data-dismiss="modal">'+this.lang.close+"</button>";if(this.dialog=utils.drawDialog(p,o,r),this.dialog.on("hidden.bs.modal",function(){$(this).empty().remove(),i.dialog=null,delete i.dialog}),this.dialog.attr("id","gp-popup"),this.dialog.find("#gp-listmoreinfo").find(".list-group-item").on("tap click",e),$("body").append(this.dialog),this.dialog.modal(),a.tabIntro){var l=utils.extractToHtml(a.tabIntro,t);"HTTP"===l.substring(0,4).toUpperCase()?this._getData(l,function(){$("#gp-intro").append(utils.extractToHtml($(this).html(),t)),smap.cmd.loading(!1)}):$("#gp-intro").append(l)}},_getData:function(t,e){var i=$("<div />");smap.cmd.loading(!0),t=this.options.useProxy?smap.config.ws.proxy+encodeURIComponent(t):t,i.load(t,e)}}),L.control.guidePopup=function(t){return new L.Control.GuidePopup(t)};
L.Control.Info=L.Control.extend({options:{addToMenu:!1,autoActivate:!1,position:"bottomright",_lang:{sv:{titleInfo:"<h4>Välkommen till smap-responsive!</h4>",bodyContent:'<h4>Vad?</h4><p>Smap-responsive är ett ramverk för att skapa kartor med "responsiv design". Det innebär att kartorna anpassar sitt innehåll efter skärmens storlek. Ramverket kan byggas ut med plugins (Leaflet-kontroller).</p><p>Koden är öppen och kan laddas ner gratis från <a target="_blank" href="https://github.com/getsmap/smap-responsive/">GitHub</a>.</p><h4>Vem?</h4><p>Ramverket har ursprungligen utvecklats av Malmö Stadsbyggnadskontor men utvecklas numera tillsammans med Kristianstad, Helsingborg och Lunds kommun.<h4>Kontakta oss!</h4><p>Har du synpunkter, frågor eller vill hjälpa till med utvecklingen? Kontakta <a href="mailto:johan.lahti@malmo.se">Johan Lahti</a>, Malmö stad.</p><p>Vill du veta mer om andra öppenkällkodsprojekt som drivs under namnet sMap – eller veta mer om bakomliggande geodata? Kontakta <a href="mailto:ulf.minor@malmo.se">Ulf Minör</a> eller <a href="mailto :Karl-Magnus.Jonsson@kristianstad.se">Karl-Magnus Jönsson.</a></p>'},en:{titleInfo:"<h4>Welcome to smap-responsive!</h4>",bodyContent:'<h4>What?</h4><p>Smap-responsive is a framework for creating maps with a "responsive design". This means the site adapts the content to the screen size. The framework can be extended with plugins (Leaflet controls).</p><p>The code is open source and can be downloaded free from <a target="_blank" href="https://github.com/getsmap/smap-responsive/">GitHub</a>.</p><h4>Who?</h4><p>The framework was originally developed by Malmö Stadsbyggnadskontor but is now developed together with the municipalities of Kristianstad, Helsingborg and Lund.<h4>Feed-back!</h4><p>Do you have suggestions, or are you interested in contributing to the development of sMap-responsive? Please contact <a href="mailto:johan.lahti@malmo.se">Johan Lahti</a>.</p><p>Do you want more info about other open source projects denoted as "sMap" – or do you want to know more about the geodata in the map(s)? Then contact <a href="mailto:ulf.minor@malmo.se">Ulf Minör</a> or <a href="mailto:Karl-Magnus.Jonsson@kristianstad.se">Karl-Magnus Jönsson.</a></p>'}}},_lang:{sv:{close:"Stäng"},en:{close:"Close"}},_setLang:function(t){t=t||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this.options._lang&&$.extend(!0,this._lang,this.options._lang),this._setLang(t.langCode)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-info"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._drawBtn(),this._container},onRemove:function(){},activate:function(){if(!this._$dialog){var t='<button type="button" class="btn btn-default" data-dismiss="modal">'+this.lang.close+"</button>";this._$dialog=utils.drawDialog(this.lang.titleInfo,this.lang.bodyContent,t)}this._$dialog.modal("show")},_drawBtn:function(){var t=this;if(this.options.addToMenu)smap.cmd.addToolButton("","fa fa-info",function(){return t.activate(),!1},null);else{var n=$('<button id="smap-info-btn" class="btn btn-default"><span class="fa fa-info"></span></button>');n.on("click",function(){return t.activate(),!1}),this.$container.append(n)}}}),L.control.info=function(t){return new L.Control.Info(t)};
L.Control.LayerSwitcher=L.Control.extend({options:{pxDesktop:992,toggleSubLayersOnClick:!0,unfoldOnClick:!0,unfoldAll:!1,catIconClass:"fa fa-chevron-right"},_lang:{sv:{baselayers:"Bakgrundslager",overlays:"Kartskikt",close:"Stäng"},en:{baselayers:"Baselayers",overlays:"Overlays",close:"Close"}},showLayer:function(t){return smap.core.layerInst.showLayer(t)},hideLayer:function(t){smap.core.layerInst.hideLayer(t)},_setLang:function(t){t=t||smap.config.langCode||navigator.language.split("-")[0]||"sv",this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.lang)},onAdd:function(t){function i(t){var i=0;$(t).on("touchstart",function(t){i=this.scrollTop+t.originalEvent.touches[0].pageY}),$(t).on("touchmove",function(t){this.scrollTop=i-t.originalEvent.touches[0].pageY})}if(this.map=t,this._container=L.DomUtil.create("div","leaflet-control-LayerSwitcher"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this.__onRowTap=this.__onRowTap||$.proxy(this._onRowTap,this),this.__onHeaderClick=this.__onHeaderClick||$.proxy(this._onHeaderClick,this),this.__onHeaderIconClick=this.__onHeaderIconClick||$.proxy(this._onHeaderIconClick,this),this.__onBtnDialogClick=this.__onBtnDialogClick||$.proxy(this._onBtnDialogClick,this),this.__onLegendEnter=this.__onLegendEnter||$.proxy(this._onLegendEnter,this),this.__onLegendLeave=this.__onLegendLeave||$.proxy(this._onLegendLeave,this),this._moveWithCursor=function(t){$(".lswitch-legend-big").css({left:t.pageX+10+"px",top:t.pageY-30+"px"})},this._addPanel(),this._addLayers(smap.config.bl,smap.config.ol),this.options.startOpened=!1,this.options.startOpened){var e=$("#lswitch-olcont, #lswitch-blcont");1===this.options.startOpened?e.children(".lswitch-cat").click():2===this.options.startOpened?e.children(".lswitch-cat").next().find(".lswitch-cat").click():this.options.startOpened===!0&&e.find(".lswitch-cat").click()}return this._addBtn(),this._bindEvents(),$("#mapdiv").addClass("lswitch-panelslide"),L.Browser.android&&i($(".lswitch-panel")),this._container},onRemove:function(){},_addLayers:function(t,i){t=t||[],i=i||[];var e;if(t.length>1)for(var s=0,n=t.length;n>s;s++)e=t[s],e.options.isBaseLayer=!0,this._addRow(e);else $(".lswitch-panel-bl").hide();if(i.length>0)for(var s=0,n=i.length;n>s;s++)e=i[s],e.options.isBaseLayer=!1,this._addRow(e);else $(".lswitch-panel-ol").hide();t.length<=1&&0===i.length&&$(".lswitch-panel").remove(),this._setSwitcherPosition(),this.__setSwitcherPosition=this.__setSwitcherPosition||$.proxy(this._setSwitcherPosition,this),$(window).on("resize",this.__setSwitcherPosition)},_setSwitcherPosition:function(){var t=0;$(".lswitch-panel").children().each(function(){t+=$(this).outerHeight()}),t>$("#mapdiv").innerHeight()-35?$(".lswitch-panel").css("position","absolute"):$(".lswitch-panel").css("position","relative");var i=utils.getBrowser();(i.ie9||i.ie10||i.ie11)&&$(".lswitch-panel").css("position","absolute"),this.hidePanel()},_bindEvents:function(){var t=this;if($("#mapdiv").on("touchstart click",$.proxy(function(){return $(window).width()<this.options.pxDesktop?(this.hidePanel(),!1):void 0},this)),L.Browser.ielt9){var t=this;this.map.on("click dragstart",function(){t.hidePanel()})}var i=($.proxy(this.showPanel,this),$.proxy(this.hidePanel,this));L.Browser.touch&&$(window).on("orientationchange",function(){t.$panel.is(":visible")&&i()}),this.map.on("layeradd layerremove",function(i){var e=i.layer||{};if(e.options&&!e.options._silent&&e.options.layerId&&!e.feature){var s=e.options.layerId,n=t._makeId(s),a=$("#"+n),o=a.hasClass("active");a.length&&("layeradd"===i.type&&o===!1?t._onRowTap({target:a}):"layerremove"===i.type&&o===!0&&t._onRowTap({target:a}))}}),smap.event.on("smap.core.createparams",function(t,i){var e=smap.core.paramInst.getParams();e.LSW&&(i.lsw=e.LSW)})},_addBtn:function(){var t=$('<div id="lswitch-btn"><span class="fa fa-bars fa-2x"></span></div>');if($("#mapdiv").prepend(t),t.on("mousedown "+L.DomEvent._touchstart,$.proxy(function(){if(!this._panelIsSliding){var t=$(".lswitch-panel").hasClass("panel-visible");t?this.hidePanel():this.showPanel()}return!1},this)),t.on("dblclick",function(){return!1}),t.is(":visible")){var i=smap.core.paramInst.getParams();i.LSW&&"1"===i.LSW&&t.trigger("mousedown")}},_addPanel:function(){this.$panel=$('<div class="lswitch-panel unselectable" />'),this.$panel.on("swipeleft",$.proxy(function(){this.hidePanel()},this)),this.$panel.on("touchstart",function(){$(this).css("overflow-y","auto")}),this.$list=$('<div class="panel panel-default lswitch-panel-bl"><div class="panel-heading">'+this.lang.baselayers+'</div><div id="lswitch-blcont" class="list-group"></div></div><div class="panel panel-default lswitch-panel-ol"><div class="panel-heading">'+this.lang.overlays+'</div><div id="lswitch-olcont" class="list-group"></div></div>'),this.$panel.append(this.$list),$("#maindiv").append(this.$panel)},showPanel:function(){var t=this;if(this.$panel.show(),this._panelIsSliding)return utils.log("no slide"),!1;this._panelIsSliding=!0,$("#lswitch-btn span").removeClass("fa-bars").addClass("fa-chevron-left"),setTimeout(function(){$(".lswitch-panel").addClass("panel-visible")},1),setTimeout(function(){t._panelIsSliding=!1},300),$("#mapdiv").addClass("mapdiv-slidetransition");var i=this.$panel.outerWidth();$("#mapdiv").css({"margin-left":i+"px",width:$("#mapdiv").outerWidth()-i+"px"})},hidePanel:function(){return this._panelIsSliding?(utils.log("no slide"),!1):($("#lswitch-btn span").removeClass("fa-chevron-left").addClass("fa-bars"),$("#mapdiv").css({"margin-left":"0",width:"100%"}),$(".lswitch-panel").removeClass("panel-visible"),$("#maindiv").addClass("lswitch-overflow-hidden"),void setTimeout($.proxy(function(){$("#mapdiv").removeClass("mapdiv-slidetransition"),this._panelIsSliding=!1,this.$panel.hide(),$("#maindiv").removeClass("lswitch-overflow-hidden")},this),300))},_setBaseLayer:function(t){var i,e=this.map._layers;for(var s in e)i=e[s],i&&i.options&&i.options.isBaseLayer&&i.options.layerId!==t&&this.hideLayer(i.options.layerId);this.showLayer(t)},_onLegendClick:function(){return $(this).parent().trigger("tap"),!1},_onRowTap:function(t){var i=$(t.target),e=i.attr("id"),s=this._unMakeId(e),n=$("#"+e).parents("#lswitch-blcont").length>0;if(n)return $("#lswitch-blcont").find("a.active").removeClass("active"),i.addClass("active"),this._setBaseLayer(s),!1;i.toggleClass("active");var a=i.hasClass("active"),o=i.parents(".lswitch-catcont");o.each(function(){if(a)$(this).prev().addClass("active");else{if($(this).find("a.list-group-item.active").length>0)return!1;$(this).prev().removeClass("active")}});var a=i.hasClass("active");if(a){var l=i.data("t")||null;this.showLayer(l||s)}else this.map.closePopup(),this.hideLayer(s);return!1},_makeId:function(t){return"lswitchrow-"+encodeURIComponent(t).replace(/%/g,"--pr--")},_unMakeId:function(t){return decodeURIComponent(t.replace("lswitchrow-","").replace(/--pr--/g,"%"))},_toggleHeader:function(t){t.next().toggleClass("lswitch-catcont-visible"),t.toggleClass("open")},_onHeaderClick:function(t,i){i=i||{};var e=this,s=t.target;s="A"===s.tagName||"SPAN"===s.tagName?$(s).parent():$(s);var n=s.next();if(!this.options.unfoldOnClick||!this.options.unfoldAll&&i.isSubHeader||this._toggleHeader(s),!this.options.toggleSubLayersOnClick&&this.options.unfoldOnClick&&this.options.unfoldAll&&n.find("div.list-group-item").each(function(){h=$(this);var t=s.hasClass("open"),i=h.hasClass("open");t!==i&&e._toggleHeader(h)}),this.options.toggleSubLayersOnClick){var a,o,l=s.hasClass("active"),r=s.hasClass("open");this.options.unfoldOnClick&&r===l&&!i.isSubHeader?l=!l:s.toggleClass("active"),n.children(".list-group-item").each(function(){o=$(this),a=o.hasClass("active"),"A"===o[0].tagName&&l===a?e._onRowTap({target:o}):"DIV"===o[0].tagName&&l===a&&e._onHeaderClick({target:o},{isSubHeader:!0})})}return $(window).width()>this.options.pxDesktop?this._setSwitcherPosition():$(".lswitch-panel").css("position","absolute"),!1},_onHeaderIconClick:function(t){var i=$(t.target);return this._toggleHeader(i.parent()),!1},_onBtnDialogClick:function(t){var i=$(t.target).parents(".list-group-item:first").data("t").options,e="",s=i.dialog;("http"===s.substring(0,4)||"//"===s.substring(0,2))&&(e='<div class="modal-body-container"><iframe frameborder="0" scrolling="auto" src="'+s+'" width="100%" height="100%" style="position:absolute;left:0;top:0;margin:0;padding:0;" frameborder="0"></iframe></div>');var n='<button type="button" class="btn btn-default" data-dismiss="modal">'+this.lang.close+"</button>",a=utils.drawDialog(i.displayName,e,n,{});a.addClass("lswitch-dialog"),a.modal("show");var o=$("#mapdiv").height();return o=o>500?500:o,a.find(".modal-body").css({"min-height":o+"px"}),a.on("hidden.bs.modal",function(){$(this).empty().remove()}),!1},_addBtnDialog:function(t){var i=$('<span class="fa fa-info-circle lswitch-btndialog" aria-hidden="true"></span>');i.on("click touchstart",this.__onBtnDialogClick),t.prepend(i)},_addLegend:function(t,i){var e=$('<img class="lswitch-legend" src="'+i+'" />');e.on("tap",this._onLegendClick).on("mouseenter",this.__onLegendEnter).on("mouseleave",this.__onLegendLeave),t.prepend(e)},_onLegendLeave:function(){$(".lswitch-legend-big").remove(),$(document).off("mousemove",this._moveWithCursor)},_onLegendEnter:function(t){var i=$(t.target),e=i.parent().data("t"),s=e.options.legendBig||e.options.legend;$(".lswitch-legend-big").remove();var n=$('<img class="lswitch-legend-big" src="'+s+'" />');$(document).on("mousemove",this._moveWithCursor),$("body").append(n)},_addRow:function(t){function i(t,n,o){return h=t[n],l=o.find('.lswitch-cat:has(span:contains("'+h+'"))'),l.length?r=l.next():(l=$('<div class="list-group-item lswitch-cat"><i class="'+e+'"></i><span>'+h+"</span></div>").appendTo(o),r=$('<div class="lswitch-catcont"></div>'),l.after(r),l.on("tap",s.__onHeaderClick),l.find("i").on("tap",s.__onHeaderIconClick)),t.length>n+1?i(t,n+1,r):(r.append(a),!0)}var e=this.options.catIconClass,s=this,n=t.options,a=$('<a class="list-group-item">'+n.displayName+"</a>");a.attr("id",this._makeId(n.layerId)),a.on("tap",this.__onRowTap),a.data("t",t),n.legend&&!L.Browser.touch&&this._addLegend(a,n.legend),n.dialog&&this._addBtnDialog(a,t);var o;if(o=$(n.isBaseLayer?"#lswitch-blcont":"#lswitch-olcont"),n.category){var l,r,h,c=n.category;i(c,0,o)}else o.append(a);return a}}),L.control.layerSwitcher=function(t){return new L.Control.LayerSwitcher(t)};
L.Control.MalmoHeader=L.Control.extend({options:{position:"bottomright"},_lang:{sv:{exampleLabel:"Ett exempel"},en:{exampleLabel:"An example"}},_setLang:function(e){e=e||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[e]:null)},initialize:function(e){L.setOptions(this,e),this._setLang(e.langCode)},onAdd:function(e){this.map=e,this._container=L.DomUtil.create("div","leaflet-control-MalmoHeader"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),smap.event.on("smap.core.pluginsadded",function(){$("#smap-search-div, .thandler-container, .thandler-btn").addClass("malmoheader-offset-top")});var t='<!--[if IE]><meta content="IE=edge" http-equiv="X-UA-Compatible" /><![endif]-->    <!--[if lte IE 8]><script src="//assets.malmo.se/external/v4/html5shiv-printshiv.js" type="text/javascript"></script><![endif]-->    <link href="//assets.malmo.se/external/v4/masthead_standalone.css" media="all" rel="stylesheet" type="text/css"/>    <!--[if lte IE 8]><link href="//assets.malmo.se/external/v4/legacy/ie8.css" media="all" rel="stylesheet" type="text/css"/><![endif]-->    <noscript><link href="//assets.malmo.se/external/v4/icons.fallback.css" rel="stylesheet"></noscript>    <link rel="icon" type="image/x-icon" href="//assets.malmo.se/external/v4/favicon.ico" />';return $("head").prepend(t),$("body").addClass("mf-v4 no-footer"),$("body").addClass("test"),$("body").append('<script src="//assets.malmo.se/external/v4/masthead_standalone_without_jquery.js"></script>'),this._container},onRemove:function(){$("#malmo-masthead").remove()}}),L.control.malmoHeader=function(e){return new L.Control.MalmoHeader(e)};
L.Control.Mapillary=L.Control.extend({options:{position:"bottomright"},_lang:{sv:{exampleLabel:"Ett exempel"},en:{exampleLabel:"An example"}},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-mapillary"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._createBtn(),this._container},onRemove:function(){},_createBtn:function(){var t=this;this.$btn=$('<button id="smap-mapillary-btn" title="'+t.lang.exampleLabel+'" class="btn btn-default"><span class="fa fa-expand"></span></button>'),this.$btn.on("click",function(){return t.activate(),!1}),this.$container.append(this.$btn)}});
L.Control.MeasureDraw=L.Control.extend({options:{position:"topright",saveMode:"url",saveWfsUrl:"",saveWfsTypeName:"",stylePolygon:{color:"#0077e2",weight:3},stylePolyline:{color:"#0077e2",weight:9}},_lang:{sv:{drawTools:"Ritverktyg",btnTitle:"Rita & Mät",drawPoint:"Punkt/Koordinater",drawLine:"Linje",drawPolygon:"Yta",drawCircle:"Cirkel",drawRectangle:"Rektangel",circumference:"Omkrets",radius:"Radie",area:"Area",len:"Längd",lenPart:"Sidlängd",easting:"Easting (x/longitud)",northing:"Northing (y/latitud)",clickToAddText:"Klicka för att lägga till text (stäng pratbubblan för att spara)",showMeasures:"Visa mätresultat",remove:"Ta bort",moreCoords:"Fler koordinatsystem",helpTextSavePopup:"Stäng pratbubblan för att spara",handlers:{circle:{tooltip:{start:"Klicka och dra för att rita cirkel."}},marker:{tooltip:{start:"Klicka i kartan för att placera markör."}},polygon:{tooltip:{start:"Klicka för att påbörja yta",cont:"Klicka igen för att fortsätta rita ytan.",end:"Dubbelklicka eller klicka första punkten för att avsluta ytan."}},polyline:{error:"<strong>Error:</strong> linjers kanter kan inte korsa varandra!",tooltip:{start:"Klicka för att påbörja linje.",cont:"Klicka för att fortsätta linje.",end:"Dubbelklicka för att avsluta linje."}},rectangle:{tooltip:{start:"Klicka och dra för att rita rektangel."}},simpleshape:{tooltip:{end:"Släpp musknappen för att avsluta."}}}},en:{drawTools:"Draw tools",btnTitle:"Draw & Measure",drawPoint:"Point/Coordinates",drawLine:"Line",drawPolygon:"Area",drawCircle:"Circle",drawRectangle:"Rectangle",circumference:"Circumference",radius:"Radius",area:"Area",len:"Length",easting:"Easting (x/longitude)",northing:"Northing (y/latitude)",clickToAddText:"Click to add text",showMeasures:"Show measure results",remove:"Remove",moreCoords:"More projections",helpTextSavePopup:"Close the popup to save"}},_setLang:function(e){e=e||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[e]:null)},initialize:function(e){L.setOptions(this,e),this._setLang(e.langCode),this._tools={},this._setLabels()},_jsonCompressDict:{'"FeatureCollection":':":fc:",'"Feature"':":F:",'"Point"':":P:",'"features":':":fs:",'"type":':":t:",'"geometry":':":g:",'"coordinates":':":c:",'"properties":':":p",'"measure_form"':":m:",'"measure_text"':":mt:"},_compressJson:function(e){var t,a=this._jsonCompressDict;for(var r in a)t=new RegExp(r,"g"),e=e.replace(t,a[r]);return e},_uncompressJson:function(e){var t,a=this._jsonCompressDict;for(var r in a)t=new RegExp(a[r],"g"),e=e.replace(t,r);return e},onAdd:function(e){this.map=e,this._container=L.DomUtil.create("div","leaflet-control-measuredraw"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._proxyListeners(),this._initDraw(),L.Browser.touch||(this._createBtn(),smap.event.on("smap.core.pluginsadded",function(){$(".leaflet-control-measuredraw .dropdown-toggle").dropdown()}));var t=this;return this.map.on("layeradd",function(){t._layer.bringToFront(),t._layer.setZIndex(1e4),t._layer.eachLayer(function(e){e.options.selectable=!0,e.options.clickable=!1,e.bringToFront&&e.bringToFront(),e.setZIndex&&e.setZIndex(1e4)})}),smap.event.on("smap.core.createparams",$.proxy(this._onCreateParams,this)),smap.event.on("smap.core.applyparams",$.proxy(this._onApplyParams,this)),this._container},_onCreateParams:function(e,t){function a(e){for(var t,r=0,o=e.length;o>r;r++)t=e[r],t instanceof Array?a(t):e[r]=L.Util.formatNum(t,5)}if("url"===this.options.saveMode){var r=[];this._layer.eachLayer(function(e){e._radius&&(e.properties.radius=e.getRadius()),e._popup&&e._popup._isOpen&&(delete t.SEL,e.properties.popupIsOpen=!0),r.push(e.properties)});for(var o,n,s=this._layer.toGeoJSON(),l=s.features,i=[],p=0,c=l.length;c>p;p++)n=l[p],o=$.extend(!0,{},n),a(o.geometry.coordinates),r[p]&&(o.properties=$.extend({},r[p]),delete o.properties.measure_form,i.push(o));s.features=i;var d=JSON.stringify(s);d=this._compressJson(d);var u=encodeURIComponent(this.options.saveMode+","+d);u=u.replace(/%3A/g,":"),u=u.replace(/%3A/g,":"),t.md=u}},_onApplyParams:function(e,t){if(t.MD){var a=decodeURIComponent(t.MD),r=a.search(","),o=a.substring(0,r),n=a.substring(r+1);if("url"===o){n=this._uncompressJson(n);var s,l=JSON.parse(n),i=L.geoJson(l),p=this;i.eachLayer(function(e){var t={Point:"marker",LineString:"polyline",Polygon:"polygon"};if("Point"===e.feature.geometry.type){var a=e.feature.geometry.coordinates;s=L.marker([a[1],a[0]]),s.properties=$.extend(!0,{},e.feature.properties)}else s=e;p.onCreated({_silent:!0,layerType:t[e.feature.geometry.type],layer:s})})}}},_proxyListeners:function(){this.__onRowClick=$.proxy(this._onRowClick,this)},onRemove:function(){},readableDistance:function(e,t){t=t||1;var a="m",r=0;if(1===t&&e>=1e3||2===t&&e>=1e5){var o=Math.pow(1e3,t-1);e/=o,e/=1e3,r=3,a="km"}return a=1===t?a:a+t,utils.round(e,r)+" "+a},onNodeClick:function(e){var t=e.latlng||null,a=this._nodes;if(this._labels=this._labels||[],t&&a.push(t),a.length>1){var r=a.slice(a.length-2),o=utils.getLength(r);if(0>=o)return!1;var n=L.latLng((r[0].lat+r[1].lat)/2,(r[0].lng+r[1].lng)/2),s=utils.createLabel(n,this.readableDistance(o,1),"leaflet-maplabel leaflet-maplabel-small");this._layer.addLayer(s),this._labels.push(s);var l=$(".leaflet-maplabel.leaflet-maplabel-small:last");l.css({"margin-left":-l.width()/2+"px"})}},_createCoordsHtml:function(e){var t=utils.projectLatLng(e,"EPSG:4326","EPSG:3006"),a=utils.projectLatLng(e,"EPSG:4326","EPSG:3008"),r=utils.projectLatLng(e,"EPSG:4326","EPSG:3021");return html="<div><strong>WGS 84 (EPSG:4326)</strong><br>Lat: &nbsp;"+utils.round(e.lng,5)+"<br>Lon: &nbsp;"+utils.round(e.lat,5)+"<div><br><button onclick=\"var tag=jQuery(this).parent().parent().parent().find('.measuredraw-morecoords');tag.toggleClass('hidden');jQuery(this).parent().remove();return false;\" class=\"btn btn-primary btn-sm\">"+this.lang.moreCoords+"</button></div></div>",html+="<br><div class='measuredraw-morecoords hidden'><strong>Sweref99 TM (EPSG:3006)</strong><br>East: &nbsp;"+utils.round(t.lng)+"<br>North: &nbsp;"+utils.round(t.lat)+"<br><br><strong>Sweref99 13 39 (EPSG:3008)</strong><br>East: &nbsp;"+utils.round(a.lng)+"<br>North: &nbsp;"+utils.round(a.lat)+"<br><br><strong>RT90 2.5 gon V (EPSG:3021)</strong><br>East: &nbsp;"+utils.round(r.lng)+"<br>North: &nbsp;"+utils.round(r.lat)+"</div>"},_getLabel:function(e){var t;return this._layer.eachLayer(function(a){a._parentFeature&&a._parentFeature===e&&(t=a)}),t},onCreated:function(e){var t=this;this._deactivateAll();var a=e.layerType,r=e.layer;if(r.properties&&r.properties.radius){var o=r.properties;a="circle",r=L.circle(r._latlng,r.properties.radius),r.properties=o}if(r.setStyle)switch(a){case"polyline":r.setStyle(this.options.stylePolyline);break;default:r.setStyle(this.options.stylePolygon)}"marker"===a&&(r.options.draggable=!0,r.on("dragstart",function(e){var t=e.target;t.closePopup()}),r.on("drag",function(e){var a=e.target,r=t._getLabel(a);r.setLatLng(a.getLatLng());var o=t._createCoordsHtml(a.getLatLng());$(r._icon).html(o)})),this._layer.addLayer(r),r.options.layerId=r._leaflet_id,r.feature&&(r.properties=r.feature.properties||r.properties,delete r.feature),r.properties&&(r.properties.measure_form||r.properties.measure_text)||(r.properties={id:r._leaflet_id,measure_form:'<div class="measuredraw-popup-div-save"><textarea class="form-control" placeholder="'+this.lang.clickToAddText+'" rows="3"></textarea></div>',measure_text:""}),r.properties.id=r._leaflet_id,r._measureDrawFeature=!0,this._layer.fire("load"),r.unbindPopup();var n,s,l,i="";switch(a){case"marker":var p=n=r.getLatLng();i=this._createCoordsHtml(p);break;case"polyline":var c=r.getLatLngs();n=c[parseInt(c.length/2)],s=utils.getLength(c),i=this.lang.len+": &nbsp;"+this.readableDistance(s,1)+"<br>";break;case"polygon":n=r.getBounds().getCenter();var c=r.getLatLngs();c.push(c[0]);var l=L.GeometryUtil.geodesicArea(c);s=utils.getLength(c),i=this.lang.circumference+": &nbsp;"+this.readableDistance(s,1)+"<br>"+this.lang.area+": &nbsp;"+this.readableDistance(l,2);break;case"circle":n=r.getBounds().getCenter();var d=r.getRadius();l=d*d*Math.PI,s=2*d*Math.PI,i=this.lang.circumference+": &nbsp;"+this.readableDistance(s,1)+"<br>"+this.lang.radius+": &nbsp;"+this.readableDistance(d,1)+"<br>"+this.lang.area+": &nbsp;"+this.readableDistance(l,2);break;case"rectangle":n=r.getBounds().getCenter();var c=r.getLatLngs();c.push(c[0]);var l=L.GeometryUtil.geodesicArea(c);s=utils.getLength(c),i=this.lang.circumference+": &nbsp;"+this.readableDistance(s,1)+"<br>"+this.lang.area+": &nbsp;"+this.readableDistance(l,2)}var u=r._leaflet_id,g="measuredrawlabel_"+u+"_",h="leaflet-maplabel "+g;if(L.Browser.touch);else{(e._silent||"rectangle"===a)&&r.getLatLngs&&(this._nodes=[],$.each(r.getLatLngs(),function(e,a){t.onNodeClick({latlng:a})}));var m=utils.createLabel(n,i,h);this._layer.addLayer(m),r.on("mouseover",this.onMouseOver),r.on("mouseout",this.onMouseOut),m.options.clickable=!0,this._labels=this._labels||[],this._labels.push(m);for(var f=this._labels||[],_=0,b=f.length;b>_;_++)f[_]._parentFeature=r;this._labels=[];var v=$(".leaflet-maplabel:last");"marker"===a&&v.css("transition","none"),v.css({"margin-left":-v.width()/2-15+"px"})}e._silent?r.properties&&r.properties.popupIsOpen&&(delete r.properties.popupIsOpen,this.map.fire("selected",{feature:r,selectedFeatures:[],layer:this._layer})):v&&(v.addClass("leaflet-maplabel-hover"),setTimeout(function(){v.removeClass("leaflet-maplabel-hover")},2e3))},returnFalse:function(){return!1},onMouseOver:function(e){$(".measuredrawlabel_"+e.target._leaflet_id+"_").addClass("leaflet-maplabel-hover")},onMouseOut:function(e){$(".measuredrawlabel_"+e.target._leaflet_id+"_").removeClass("leaflet-maplabel-hover")},_setLabels:function(){var e=L.drawLocal.draw;$.extend(!0,e.handlers,this.lang.handlers||{})},_selection:function(e){var t,a,r=[smap.cmd.getControl("L.Control.SelectWMS"),smap.cmd.getControl("L.Control.SelectVector")];for(a=0;a<r.length;a++)t=r[a],t&&(e===!0?t.activate():t.deactivate())},_initDraw:function(){this._layer=L.featureGroup(),this._layer.options={layerId:"measurelayer",popup:"${measure_text}${measure_form}",uniqueKey:"id"},this.map.addLayer(this._layer),this._drawControl=new L.Control.Draw({draw:{marker:!1,polyline:!1,polygon:!1,rectangle:!1,circle:!1},edit:null}),this._onCreated=this._onCreated||$.proxy(this.onCreated,this),this._onNodeClick=this._onNodeClick||$.proxy(this.onNodeClick,this),this._onPopupOpen=this._onPopupOpen||$.proxy(this.onPopupOpen,this),this.map.on("draw:created",this._onCreated);var e=this;this.map.on("draw:drawstart",function(){e._nodes=[],e._selection(!1),e.map.on("click",e._onNodeClick)}),this.map.on("draw:drawstop",function(t){e.map.off("click",e._onNodeClick),e._nodes&&_.indexOf(["polygon","rectangle"],t.layerType)>-1&&e._onNodeClick({latlng:e._nodes[0]}),e._selection(!0)}),this.map.on("popupopen",this._onPopupOpen)},_removeFeature:function(e){{var t=this;this._labels}this._layer.eachLayer(function(a){a._parentFeature&&a._parentFeature===e&&t.map.removeLayer(a)}),this._layer.removeLayer(e)},onPopupOpen:function(e){var t=this,a=e.popup&&e.popup._source?e.popup._source:null;if(a&&a._measureDrawFeature){var r=smap.cmd.getControl("L.Control.SelectWMS");r._dblclickWasRegistered=!0,r&&setTimeout(function(){r._dblclickWasRegistered=!1},400);var o=$(".measuredraw-popup-div-save textarea"),n='<br><br><button class="btn btn-default btn-sm measuredraw-btn-popupremove">'+this.lang.remove+"</button>",s=e.popup,l=s.getContent();-1===l.search("measuredraw-btn-popupremove")&&(l+=n,s.setContent(l),s.update(),o=$(".measuredraw-popup-div-save textarea")),$(".leaflet-popup-content").find(".measuredraw-btn-popupremove").on("click",function(){return t._removeFeature(a),!1}),o.length&&(o.tooltip({placement:"top",title:this.lang.helpTextSavePopup,container:".leaflet-popup",trigger:"manual"}),o.on("keypress",function(){$(".tooltip:visible").length||$(this).tooltip("show")}),o.on("focus",function(){$(".measuredraw-btn-popupremove").prop("disabled",!0)}),o.on("blur",function(){$(".measuredraw-btn-popupremove").prop("disabled",!1),$(this).tooltip("hide");var t=e.popup._source,a=$(this).val();""===a||(t.properties.measure_text=a,t.properties.measure_form="",t.closePopup())}))}},_getDrawToolbar:function(e){var t;for(var a in this._drawControl._toolbars)if(t=this._drawControl._toolbars[a],t&&t._modes&&t._modes[e])return t._modes[e];return null},_deactivateAll:function(){var e=this._tools;for(var t in e)e[t].disable(),this.$container.find(".dropdown-menu li.active").removeClass("active")},_onRowClick:function(e){var t="li"===e.target.tagName?$(e.target):$(e.target).parents("li"),a=t.data("geomType");return t.hasClass("active")?(t.removeClass("active"),this._tools[a].disable()):(this._deactivateAll(),t.toggleClass("active"),this._tools[a].enable(),setTimeout(function(){$(".leaflet-control-measuredraw .dropdown-menu").dropdown("toggle")},200)),!1},_createRow:function(e){var t=$('<li><a><div><span class="drawicons '+e.cl+'"></span><span>'+e.label+"</span></div></a></li>");t.data("geomType",e.geomType),t.on("click",this.__onRowClick);var a=L.Draw[utils.capitalize(e.geomType)],r=new a(this.map,this._drawControl.options.draw[e.geomType]);r.options.shapeOptions=r.options.shapeOptions||{};var o={};switch(e.geomType){case"polyline":o=this.options.stylePolyline;break;default:o=this.options.stylePolygon}return $.extend(r.options.shapeOptions,o),this._tools[e.geomType]=r,t},_createBtn:function(){for(var e,t,a=[{label:this.lang.drawPoint,cl:"leaflet-draw-draw-marker",geomType:"marker"},{label:this.lang.drawLine,cl:"leaflet-draw-draw-polyline",geomType:"polyline"},{label:this.lang.drawPolygon,cl:"leaflet-draw-draw-polygon",geomType:"polygon"},{label:this.lang.drawCircle,cl:"leaflet-draw-draw-circle",geomType:"circle"},{label:this.lang.drawRectangle,cl:"leaflet-draw-draw-rectangle",geomType:"rectangle"}],r=$('<div class="btn-group"><button type="button" title="'+this.lang.btnTitle+'" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><span class="drawicons leaflet-draw-draw-marker measuredraw-btntoggle-image"></span></button><ul class="dropdown-menu" role="menu"></ul></div>'),o=r.find(".dropdown-menu"),n=0,s=a.length;s>n;n++)t=a[n],e=this._createRow(t),o.append(e);this.$container.append(r)}}),L.control.measureDraw=function(e){return new L.Control.MeasureDraw(e)};
L.Control.Menu=L.Control.extend({options:{position:"topright",btnID:"my-btn"},_lang:{sv:{caption:"Exempeltext som jag ändrar"},en:{caption:"Share position link"}},_setLang:function(n){n=n||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[n]:null)},initialize:function(n){L.setOptions(this,n),this._setLang(n.langCode)},onAdd:function(n){this.map=n,this._container=L.DomUtil.create("div","leaflet-control-Menu"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._createMenu();var a="";return this.options.btnID&&(a=this.options.btnID),this.addButton(a,"My button","fa fa-link",function(){return!1}),this._container},addButton:function(n,a,t,o,i){i=i||{};var s=n||"",e=$('<li><a id="'+s+'" href="btn btn-default"><span class="'+t+'"></span> '+a+"</a></li>");i.proxy&&(o=$.proxy(o,i.proxy)),e.on("click",o),$("#btns").append(e),i.callback&&i.callback(e)},_createMenu:function(){var n=$('<header id="smap-menu-div" class="navbar navbar-static-top bs-docs-nav" role="banner"><div class="container"><div class="navbar-header">    <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">      <span class="sr-only">Toggle navigation</span>      <span class="fa fa-bars"></span>    </button><a class="navbar-brand" href="#">Stadsatlas</a>  </div>  <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">    <ul id="btns" class="nav navbar-nav navbar-right">    </ul>  </nav></div></header>');$("#maindiv").prepend(n)},onRemove:function(){}}),L.control.menu=function(n){return new L.Control.Menu(n)};
L.Control.Opacity=L.Control.extend({options:{position:"bottomright",addToMenu:!1},_lang:{sv:{caption:"Ändra genomskinlighet på lager",close:"Stäng",collapsebtn:"visa/dölj lagerlista",btntitle:"Justera transparens",prefTxt:"Spara inställningar"},en:{caption:"Transparency tool",close:"Close",collapsebtn:"show/hide layers",btntitle:"Adjust transparency",prefTxt:"Save settings"}},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},onAdd:function(t){var a=this;return a.allNamesInGui=[],t.on("layeradd layerremove",function(t){if(t.layer.options&&t.layer.options.layerId&&!t.layer.feature){var e=t.layer.options.layerId;if(-1==$.inArray(e,a.allNamesInGui))a.allNamesInGui.push(e);else if("layerremove"===t.type){var o=$.inArray(e,a.allNamesInGui);a.allNamesInGui.splice(o,1),$("#op-rowsdiv").find("#"+e).remove()}}}),a._container=L.DomUtil.create("div","leaflet-control-Opacity"),L.DomEvent.disableClickPropagation(a._container),a.$container=$(a._container),a._createBtn(),a._container},_addLayers:function(t){var e=$("<div class='op-opdiv'><button id='op-collapsebtn' type='button' class='btn' data-toggle='collapse' data-target='#op-rowsdiv'>"+this.lang.collapsebtn+"</button><div id='op-rowsdiv' class='collapse in'></div></div>"),o=e.children("#op-rowsdiv");return a=0,$.each(t,function(){var t=smap.core.layerInst._getLayer(this);if(null!=t){var e=null!=t.options.opacity?t.options.opacity:1,n=Math.round(100*e),i=$("<div class='op-rows' id='"+t.options.layerId+"' ><span class='op-mapname'>"+t.options.displayName+"</span><span class='op-values'>"+n+"</span><input class='op-sliderdiv' data-slider-tooltip='hide'data-slider-id='slider"+a+"' type='text' data-slider-min='0' data-slider-max='100' data-slider-value='"+n+"' data-slider-step='1'/>");i.children("input").slider().on("slide",function(t){var a=$(this).closest("div.op-rows"),e=a.get(0).id,o=smap.core.layerInst._getLayer(e);o.setOpacity?o.setOpacity(t.value/100):o.options.style&&o.setStyle({opacity:t.value/100,fillOpacity:t.value/100}),a.children("span.op-values").text(t.value)}).on("slideStart",function(){$("#op-modal").addClass("op-modal-slideeffect")}).on("slideStop",function(){$("#op-modal").removeClass("op-modal-slideeffect")}),a+=1,o.append(i)}}),e},_onClose:function(){this.options.savePrefBox&&0==$("#op-prefs").is(":checked")&&$.each($("div.op-rows"),function(){smap.core.layerInst._getLayer(this.id).setOpacity?smap.core.layerInst._getLayer(this.id).setOpacity(1):theLyr.options.style&&theLyr.setStyle({opacity:1,fillOpacity:1}),$(this).children("span.op-values").text(100)})},activate:function(){var t=this,a=t._addLayers(t.allNamesInGui);if(!t._$dialog){if(t.options.savePrefBox&&1==t.options.savePrefBox)var e="<div id='op-prefdiv'><label for='op-prefs'>"+t.lang.prefTxt+"</label><input id='op-prefs' type='checkbox'  name='saveprefs' checked /></div><button type='button' class='btn btn-default' data-dismiss='modal'>"+this.lang.close+"</button>";else var e='<button type="button" class="btn btn-default" data-dismiss="modal">'+this.lang.close+"</button>";t._$dialog=utils.drawDialog(t.lang.caption,a,e),t._$dialog.attr("id","op-modal"),t._$dialog.on("hidden.bs.modal",function(){t._onClose(),t._$dialog.empty().remove(),t._$dialog=null})}t._$dialog.modal("show")},_createBtn:function(){var t=this;if(t.options.addToMenu)smap.cmd.addToolButton("","fa fa-adjust",function(){return t.activate(),!1},null);else{var a=$('<button id="smap-opacity-btn" title="'+t.lang.btntitle+'" class="btn btn-default"><span class="fa fa-adjust"></span></button>');a.on("click",function(){return t.activate(),!1}),t.$container.append(a)}},onRemove:function(){}}),L.control.opacity=function(t){return new L.Control.Opacity(t)};
L.Control.Print=L.Control.extend({options:{position:"topleft",addToMenu:!1,printUrl:"//localhost/print-servlet/print"},_lang:{sv:{caption:"Skriv ut",mTitle:"Skriv ut/Exportera",header:"Rubrik",tip_header:"Rubrik (valfritt)",descript:"Beskrivning",tip_descript:"Beskrivning (valfritt)",layout:"Pappersformat",resolution:"Upplösning",orientation:"Orientering",portrait:"Stående",landscape:"Liggande",create:"Skapa bild",close:"Stäng",loading:"Laddar…",processingPrint:"Skapar bild…",northarrow:"Nordpil",scale:"Skala",misc:"Övrigt",legend:"Teckenförklaring"},en:{caption:"Skriv ut",mTitle:"Skriv ut/Exportera",header:"Rubrik",tip_header:"Rubrik (valfritt)",descript:"Beskrivning",tip_descript:"Beskrivning (valfritt)",layout:"Layout",resolution:"Resolution",orientation:"Orientation",portrait:"Portrait",landscape:"landscape",create:"Create image",close:"Stäng",loading:"Laddar…",processingPrint:"Creating image…",northarrow:"North arrow",scale:"Scale",misc:"Miscellaneous",legend:"Legend"}},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-Print"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._createBtn(),this._initPrint(),this._drawModal(),this._container},onRemove:function(){this._removeBtn(),this._destroyPrint()},_createBtn:function(){var t=this;this.$btn=$('<button id="smap-print-btn" title="'+t.lang.caption+'" class="btn btn-default"><span class="fa fa-print"></span></button>'),this.$btn.on("click touchstart",function(){return t.show(),!1}),this.$container.append(this.$btn)},_removeBtn:function(){this.$btn.remove()},_initPrint:function(){var t=this;L.mapbox=L.mapbox||{TileLayer:L.Class.extend({})},this.printProvider=L.print.provider({method:"POST",url:this.options.printUrl,autoLoad:!0,copy:"© Stadsbyggnadskontoret, Malmö stad",layout:"A4_Portrait_NoArrow_NoBar",outputFormat:"pdf",map:this.map}),this.printProvider.on("printexception printsuccess",function(){var i=t._modal.find("button[type='submit']");i.button("reset"),smap.cmd.loading(!1)}),this.printOptions={paperFormat:"A4",orientation:"Portrait",arrow:!1,scalebar:!1,dpi:96,legends:[]},this.printProvider.on("capabilitiesload",function(t){t.capabilities.printURL=t.capabilities.printURL.replace(/localhost:8080/g,"localhost").replace(document.domain,"localhost"),t.capabilities.createURL=t.capabilities.createURL.replace(/localhost:8080/g,"localhost").replace(document.domain,"localhost")})},_destroyPrint:function(){this.printProvider.destroy(),this.printProvider=null,this._modal.remove()},_getMercatorScaleForLat:function(){var t=this.map.getCenter().lat,i=this.printProvider._getScale(),n=1/Math.cos(t*Math.PI/180);return i=parseInt(Math.round(i/n))},_makeLegends:function(){var t,i,n,e,a=[],r=this.map._layers;for(lid in r)t=r[lid],e=t.options,!e||void 0!==e.legend&&e.legend===!1||e&&(e.legend||t instanceof L.TileLayer.WMS||t instanceof L.GeoJSON.WFS)&&(i=e.legend,i&&i.length||(i=-1===t._url.search(/\?/)?t._url+"?":t._url,i=i+"request=GetLegendGraphic&format=image/png&width=20&height=20&layer="+e.layers),i&&(n=e.displayName||"Unnamed layer"),a.push({name:n,icon:i}));var o=[{name:"Teckenförklaring",classes:a}];return o},_preprocessPrintOptions:function(t){var i={mapTitle:t.mapTitle,comment:t.comment,dpi:t.dpi,legends:this._makeLegends(),displayscale:this.lang.scale+" 1:",layout:[t.paperFormat,t.orientation,t.legend?"Legend":"NoLegend"].join("_")};return i},_preprocessLayers:function(){var t,i=this.map;for(t in i._layers){var n=i._layers[t];if(n instanceof L.NonTiledLayer.WMS&&!n.options.printLayer){var e=smap.cmd.getLayerConfig(n.options.layerId);e&&(e.init="L.TileLayer.WMS",n.options.printLayer=$.extend(!0,{},e))}}},print:function(t){if(!this.printProvider._capabilities)return!1;var i=this._modal.find("button[type='submit']");i.attr("data-loading-text",this.lang.processingPrint),i.button("loading"),smap.cmd.loading(!0),this._preprocessLayers(),this.printProvider.print(t)},_drawModal:function(){var t=this,i="resources/PrintModal.html";document.URL.search(/\/dev.html/)>-1&&(i="plugins/Print/"+i),$.get(i,function(i){i=utils.extractToHtml(i,t.lang),t._modal=utils.drawDialog(t.lang.mTitle,i),t._modal.addClass("sprint-modal"),t._modal.find("form").submit(function(){var i=utils.paramsStringToObject($(this).serialize(),!1);return i=t._preprocessPrintOptions(i),t.printProvider.setDpi(i.dpi),t.print(i),!1}),smap.event.trigger("smap:print:modaldrawn")})},_loadCapabilities:function(){var t=this;this._modal.find('button[type="submit"]').button("loading"),this.printProvider.loadCapabilities().done(function(){t._modal.find('button[type="submit"]').button("reset")})},show:function(){var t=this;this.printProvider._capabilities||this._loadCapabilities(),this._modal?this._modal.modal("show"):smap.event.off("smap:print:modaldrawn").on("smap:print:modaldrawn",function(){t._modal.modal("show")})},hide:function(){this._modal.modal("hide")}}),L.control.Print=function(t){return new L.Control.Print(t)};
L.Control.Printer=L.Control.extend({options:{position:"bottomright"},_lang:{sv:{exampleLabel:"Ett exempel"},en:{exampleLabel:"An example"}},_setLang:function(n){n=n||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[n]:null)},initialize:function(n){L.setOptions(this,n),this._setLang(n.langCode)},onAdd:function(n){return this.map=n,this._container=L.DomUtil.create("div","leaflet-control-printer"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._container},onRemove:function(){}});
L.Control.RedirectClick=L.Control.extend({options:{position:"topright",btnID:"smap-redirect-btn"},_setLang:function(t){t=t||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this._lang=$.extend(!0,this._lang,this.options._lang),this.lang=this._lang?this._lang[t]:null)},initialize:function(t){this._lang={sv:{},en:{}},L.setOptions(this,t),this._setLang(t.langCode)},_setURL:function(t){var i=this;i.options.url=t?t||i.options.url:null},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-RedirectClick"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._createButton(),this._container},addHooks:function(){this._tooltip={},this._tooltip.text=this.lang.hoverText,this.tooltip=new L.Tooltip(this.map).updateContent(this._tooltip),this.map.on("click",this.onMapClick,this),this.map.on("mousemove mouseup",this._onMouseMove,this)},removeHooks:function(){this.map&&this.tooltip&&(this.tooltip.dispose(),this.map.off("click",this.onMapClick,this),this.map.off("mousemove mouseup",this._onMouseMove,this))},_projectEPSG:function(t){var i=new Proj4js.Proj("EPSG:4326"),o=new Proj4js.Proj("EPSG:3008"),n=(L.Proj,new Proj4js.Point(t.latlng.lng,t.latlng.lat));return Proj4js.transform(i,o,n),t.latlng.lat=n.x,t.latlng.lng=n.y,t},_onMouseMove:function(t){this.tooltip.updatePosition(t.latlng)},onMapClick:function(t){this.onDone(t),this._deactivate()},_createButton:function(){var t=this,i=$('<button id="'+this.options.btnID+'" title="'+this.lang.name+'" class="btn btn-default"><span class="'+this.options.btnClass+'"></span></button>');i.on("click touchstart",function(){return t.active&&t.active!==!1?(t._deactivate(),$("#mapdiv").focus(),t.active=!1):(t._deactivate(),t._activate(),t.active=!0),!1}),t.$container.append(i)},_activate:function(){var t=this;return t.active?!1:(this._deactivateAll(),void(this.options.url?this.map&&(t.removeHooks(),t.addHooks(),$("#mapdiv").css({cursor:t.options.cursor})):(t._deactivate(),$("#mapdiv").focus(),utils.log("RedirectClick error: Redirect URL missing. Check config-file."))))},_deactivate:function(){this.active=!1,this.removeHooks(),$("#mapdiv").css({cursor:""})},_deactivateAll:function(){for(var t=smap.cmd.getControls("RedirectClick"),i=0;i<t.length;i++)t[i]._deactivate()},onRemove:function(){this.$container.empty()},onDone:function(t){var i=this,o=i.options.url,n=new proj4.Proj("EPSG:4326"),e=new proj4.Proj("EPSG:3008"),s={x:t.latlng.lng,y:t.latlng.lat};proj4.transform(n,e,s),o=o.replace(/\${x}/g,s.x).replace(/\${y}/g,s.y),window.open(o,this.lang.name)}}),L.control.redirectclick=function(t){return new L.Control.RedirectClick(t)};
L.Control.Search=L.Control.extend({options:{whitespace:"%2B",wsOrgProj:"EPSG:3006",pxDesktop:992,gui:!1,addToMenu:!1,zoom:15},_lang:{sv:{search:"Sök adress",addressNotFound:"Den sökta adressen hittades inte",remove:"Ta bort"},en:{search:"Search address",addressNotFound:"The searched address was not found",remove:"Remove"}},_setLang:function(s){s=s||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this.lang=this._lang?this._lang[s]:null)},initialize:function(s){L.setOptions(this,s),this.options._lang&&$.extend(!0,this._lang,this.options._lang),this._setLang(s.langCode)},onAdd:function(s){var t=this;return this.map=s,this._container=L.DomUtil.create("div","leaflet-control-search"),L.DomEvent.disableClickPropagation(this._container),(void 0===this.options.gui||this.options.gui===!0)&&(this.$container=$(this._container),this.$container.css("display","none"),this._makeSearchField(),this.map.on("click",this._blurSearch)),this.__onApplyParams=this.__onApplyParams||$.proxy(this._onApplyParams,this),smap.event.on("smap.core.applyparams",this.__onApplyParams),this.__onCreateParams=this.__onCreateParams||$.proxy(this._onCreateParams,this),smap.event.on("smap.core.createparams",this.__onCreateParams),t._container},_blurSearch:function(){$("#smap-search-div input").blur()},onRemove:function(){smap.event.off("smap.core.applyparams",this.__onApplyParams),smap.event.off("smap.core.createparams",this.__onCreateParams),this.map.off("click",this._blurSearch)},_onApplyParams:function(s,t){if(t.POI){var o=t.POI instanceof Array?t.POI[0]:t.POI;o=o.replace(/--c--/g,",");var e=t.POI instanceof Array&&t.POI.length>1?t.POI[1]:!1,a=!1,n=smap.core.paramInst.getParams();n.ZOOM||n.CENTER||(a=!0),this._geoLocate(decodeURIComponent(o),{setView:a,showPopup:e})}},_onCreateParams:function(s,t){if(this.marker&&this.marker.options.q){var o=this.marker.getPopup()._isOpen?!0:!1;t.POI=[encodeURIComponent(this.marker.options.q.replace(/,/g,"--c--"))],o&&t.POI.push(1)}},_rmAdressMarker:function(s){null!=s&&(this.map.removeLayer(s),this.addressMarker=null)},_makeSearchField:function(){function s(){var s=$(window).width();if(!(s>=e.options.pxDesktop)&&L.Browser.touch){var t=$("#smap-search-bg");t.length||(t=$('<div id="smap-search-bg" />'),a.addClass("search-active"),$("#mapdiv").append(t),setTimeout(function(){t.addClass("search-bg-visible")},1))}}function t(){var s=$(window).width();s>=e.options.pxDesktop||!L.Browser.touch||(a.removeClass("search-active"),$("#smap-search-bg").removeClass("search-bg-visible"),setTimeout(function(){$("#smap-search-bg").remove()},300))}function o(s){s.stopPropagation()}var e=this,a=$('<div id="smap-search-div" class="input-group input-group-lg"><span class="input-group-addon"><span class="glyphicon glyphicon-search"></span></span><input autocorrect="off" autocomplete="off" data-provide="typeahead" type="text" class="form-control" placeholder="'+this.lang.search+'"></input></div>'),n=a.find("input");L.Browser.msTouch&&n.attr("pattern","[0-9]"),n.on("keypress",s).on("dblclick",o).on("mousedown",o).on("focus",function(){$(this).parent().addClass("smap-search-div-focused")}).on("blur",function(){$(this).parent().removeClass("smap-search-div-focused")}).on("touchstart",function(){$(this).focus()}),a.on("click touchstart",function(s){$(this).find("input").focus(),s.stopImmediatePropagation()}),n.on("blur",t),$("#mapdiv").append(a),smap.event.on("smap.core.pluginsadded",function(){var s=$("#smap-menu-div nav");s.length&&a.addClass("smap-search-div-in-toolbar")});var i=this.options.whitespace,r=this.options._geoLocate||this._geoLocate,p={items:5,minLength:2,highlight:!0,hint:!0,updater:function(s){return smap.cmd.loading(!0),r.call(e,s),t(),s}};this.options.wsAcUrl?p.source=function(s,t){s=encodeURIComponent(s);var o=e.options.wsAcUrl;i&&(s=s.replace(/%20/g,i)),e.proxyInst&&e.proxyInst.abort(),e.proxyInst=$.ajax({type:"GET",url:e.options.useProxy?smap.config.ws.proxy+encodeURIComponent(o+"?q=")+s:o+"?q="+s,dataType:"text",success:function(s){var o=s.split("\n");t(o)},error:function(){}})}:this.options.wsAcLocal&&this.options.wsAcLocal instanceof Array&&(p.source=this.options.wsAcLocal),n.typeahead(p)},_geoLocate:function(s,t){t=t||{};var o={setView:!0,showPopup:!0};t=$.extend({},o,t),this.options.qPattern&&(s=utils.extractToHtml(this.options.qPattern,{q:s})),s=encodeURIComponent(s);var e=this.options.wsLocateUrl;if(this.options.useProxy){e=smap.config.ws.proxy+encodeURIComponent(e+"?q=")+s;var a=this.options.whitespace;a&&(e=e.replace(/%20/g,a))}else e=e+"?q="+s;var n={success:function(o){function e(){$("#smap-search-popupbtn").off("click").on("click",function(){return a.map.removeLayer(a.marker),a.marker=null,!1})}var a=this;if(this.marker&&(this.map.removeLayer(this.marker),this.marker=null),!o.features.length)return void smap.cmd.notify(this.lang.addressNotFound,"error");var n=o.features[0].geometry.coordinates,i=L.latLng(n[1],n[0]),r="EPSG:4326";if(this.options.wsOrgProj&&this.options.wsOrgProj!==r){var p=window.proj4(this.options.wsOrgProj,r,[i.lng,i.lat]);i=L.latLng(p[1],p[0])}this.map.off("popupopen",e),this.map.on("popupopen",e),this.marker=L.marker(i).addTo(this.map),this.marker.options.q=s,this.marker.bindPopup('<p class="lead">'+decodeURIComponent(s)+'</p><div><button id="smap-search-popupbtn" class="btn btn-default">'+this.lang.remove+"</button></div>"),t.setView&&this.map.setView(i,this.options.zoom,{animate:!1}),t.showPopup&&this.marker.openPopup(),$("#smap-search-div input").val(null),$("#smap-search-div input").blur(),setTimeout(function(){$("#smap-search-div input").blur()},100)},complete:function(){smap.cmd.loading(!1)}};$.ajax({url:e,type:"GET",dataType:"json",context:this,success:this.options.onLocateSuccess||n.success,complete:n.complete})},CLASS_NAME:"L.Control.Search"}),L.control.search=function(s){return new L.Control.Search(s)};
L.Control.SearchLund=L.Control.extend({options:{whitespace:"%2B",wsOrgProj:"EPSG:3006",pxDesktop:992,addToMenu:!1},_lang:{sv:{search:"Sök",addressNotFound:"Den sökta adressen hittades inte",remove:"Ta bort"},en:{search:"Search property",addressNotFound:"The searched address was not found",remove:"Remove"}},_setLang:function(t){t=t||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},onAdd:function(t){var o=this;return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-searchlund"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this.$container.css("display","none"),this._makeSearchField(),this.__onApplyParams=this.__onApplyParams||$.proxy(this._onApplyParams,this),smap.event.on("smap.core.applyparams",this.__onApplyParams),this.__onCreateParams=this.__onCreateParams||$.proxy(this._onCreateParams,this),smap.event.on("smap.core.createparams",this.__onCreateParams),this.map.on("click",this._blurSearch),o._container},_blurSearch:function(){$("#smap-searchlund-div input").blur()},onRemove:function(){smap.event.off("smap.core.applyparams",this.__onApplyParams),smap.event.off("smap.core.createparams",this.__onCreateParams),this.map.off("click",this._blurSearch)},_onApplyParams:function(t,o){if(o.POI){var a=o.POI instanceof Array?o.POI[0]:o.POI;a=a.replace(/--c--/g,",");var e=o.POI instanceof Array&&o.POI.length>1?o.POI[1]:!1;this._geoLocate(decodeURIComponent(a),{setView:!1,showPopup:e})}},_onCreateParams:function(t,o){if(this.marker&&this.marker.options.q){var a=this.marker.getPopup()._isOpen?!0:!1;o.POI=[encodeURIComponent(this.marker.options.q.replace(/,/g,"--c--"))],a&&o.POI.push(1)}},_rmAdressMarker:function(t){null!=t&&(this.map.removeLayer(t),this.addressMarker=null)},_makeSearchField:function(){function t(){var t=$(window).width();if(!(t>=e.options.pxDesktop)&&L.Browser.touch){var o=$("#smap-searchlund-bg");o.length||(o=$('<div id="smap-searchlund-bg" />'),s.addClass("searchlund-active"),$("#mapdiv").append(o),setTimeout(function(){o.addClass("searchlund-bg-visible")},1))}}function o(){var t=$(window).width();t>=e.options.pxDesktop||!L.Browser.touch||(s.removeClass("searchlund-active"),$("#smap-searchlund-bg").removeClass("searchlund-bg-visible"),setTimeout(function(){$("#smap-searchlund-bg").remove()},300))}function a(t){t.stopPropagation()}var e=this,s=$('<div id="smap-searchlund-div" class="input-group input-group-lg"><span class="input-group-addon"><span class="glyphicon glyphicon-search"></span></span><input autocorrect="off" autocomplete="off" data-provide="typeahead" type="text" class="form-control" placeholder="'+this.lang.search+'"></input></div>'),n=s.find("input");L.Browser.msTouch&&n.attr("pattern","[0-9]"),n.on("keypress",t).on("dblclick",a).on("mousedown",a).on("focus",function(){$(this).parent().addClass("smap-searchlund-div-focused")}).on("blur",function(){$(this).parent().removeClass("smap-searchlund-div-focused")}).on("touchstart",function(){$(this).focus()}),s.on("click touchstart",function(t){$(this).find("input").focus(),t.stopImmediatePropagation()}),n.on("blur",o),$("#mapdiv").append(s),smap.event.on("smap.core.pluginsadded",function(){var t=$("#smap-menu-div nav");t.length&&s.addClass("smap-searchlund-div-in-toolbar")});var r=this.options.whitespace,p=this.options._geoLocate||this._geoLocate,c={items:10,minLength:2,highlight:!0,hint:!0,updater:function(t){return smap.cmd.loading(!0),p.call(e,t),o(),t}};this.options.wsAcUrl?c.source=function(t,o){var a=encodeURIComponent(e.options.wsAcUrl+"?format=json&prefix="+t);r&&(a=a.replace(/%20/g,r)),e.proxyInst&&e.proxyInst.abort(),e.proxyInst=$.ajax({type:"GET",url:smap.config.ws.proxy+a,dataType:"text",success:function(t){var a=$.parseJSON(t),e=[];for(i=0,len=a.items.length;len>i;i++)e[i]=a.items[i].name.split(",")[0];o(e)},error:function(){}})}:this.options.wsAcLocal&&this.options.wsAcLocal instanceof Array&&(c.source=this.options.wsAcLocal),n.typeahead(c)},_geoLocate:function(t,o){o=o||{};var a={setView:!0,showPopup:!0};o=$.extend({},a,o),this.options.qPattern&&(t=utils.extractToHtml(this.options.qPattern,{q:t}));var e=encodeURIComponent(this.options.wsLocateUrl+"?format=json&prefix="+t),s=this.options.whitespace;s&&(e=e.replace(/%20/g,s));var n={success:function(a){function e(){$("#smap-searchlund-popupbtn").off("click").on("click",function(){return s.map.removeLayer(s.marker),s.marker=null,s.polyLayerGroup.clearLayers(),s.map.removeLayer(s.polyLayerGroup),!1})}var s=this;if(this.marker&&(this.map.removeLayer(this.marker),this.marker=null,this.polyLayerGroup.clearLayers(),s.map.removeLayer(this.polyLayerGroup)),!a.items.length)return void smap.cmd.notify(this.lang.addressNotFound,"error");for(var n=[],r=0,i=a.items.length;i>r;r++)n[r]=$.parseJSON(a.items[r].geometry);if("MultiPoint"==n[0].type){var p=L.latLng(n[0].coordinates[0][1],n[0].coordinates[0][0]),c="EPSG:4326";if(this.options.wsOrgProj&&this.options.wsOrgProj!==c){var l=window.proj4(this.options.wsOrgProj,c,[p.lng,p.lat]);p=L.latLng(l[1],l[0])}}if("Polygon"==n[0].type){for(var p,h=[],u=0;u<n.length;u++)h[u]=[];for(var d=0,m=n.length;m>d;d++)for(var u=0,f=n[d].coordinates[0].length;f>u;u++){var p=L.latLng(n[d].coordinates[0][u][1],n[d].coordinates[0][u][0]),c="EPSG:4326";if(this.options.wsOrgProj&&this.options.wsOrgProj!==c){var l=window.proj4(this.options.wsOrgProj,c,[p.lng,p.lat]);p=L.latLng(l[1],l[0])}h[d].push(p)}}if(this.map.off("popupopen",e),this.map.on("popupopen",e),"MultiPoint"==n[0].type&&(this.marker=L.marker(p).addTo(this.map),this.marker.options.q=t,this.marker.bindPopup('<p class="lead">'+t+'</p><div><button id="smap-searchlund-popupbtn" class="btn btn-default">'+this.lang.remove+"</button></div>"),o.setView&&this.map.setView(p,17,{animate:!1})),"Polygon"==n[0].type){this.polyLayerGroup=new L.LayerGroup;for(var u=0;u<n.length;u++)this.mapPolygon=L.polygon(h[u]),this.polyLayerGroup.addLayer(this.mapPolygon);this.map.addLayer(this.polyLayerGroup);var g=this.mapPolygon.getBounds().getCenter();this.marker=L.marker(g).addTo(this.map),this.marker.options.q=t,this.marker.bindPopup('<p class="lead">'+t+'</p><div><button id="smap-searchlund-popupbtn" class="btn btn-default">'+this.lang.remove+"</button></div>"),o.setView&&this.map.setView(p,17,{animate:!1})}o.showPopup&&this.marker.openPopup(),$("#smap-searchlund-div input").val(null),$("#smap-searchlund-div input").blur(),setTimeout(function(){$("#smap-searchlund-div input").blur()},100)},complete:function(){smap.cmd.loading(!1)}};$.ajax({url:smap.config.ws.proxy+e,type:"GET",dataType:"json",context:this,success:this.options.onLocateSuccess||n.success,complete:n.complete})},CLASS_NAME:"L.Control.SearchLund"}),L.control.searchLund=function(t){return new L.Control.SearchLund(t)};
L.Control.SelectVector=L.Control.extend({options:{position:"bottomright",selectStyle:{weight:5,color:"#00FFFF",fillColor:"#00FFFF",opacity:1,fillOpacity:.5}},_lang:{sv:{exampleLabel:"Ett exempel"},en:{exampleLabel:"An example"}},_selectedFeatures:[],_setLang:function(e){e=e||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[e]:null)},initialize:function(e){L.setOptions(this,e),this._setLang(e.langCode);var t=this;this._onFeatureClick=function(e){var i=200;t._clickWasRegistered||(t.onFeatureClick(e),t._clickWasRegistered=!0,setTimeout(function(){t._clickWasRegistered=!1},i))}},activate:function(){this._active=!0},deactivate:function(){this._active=!1},onAdd:function(e){return this.map=e,this._container=L.DomUtil.create("div","leaflet-control-selectvector"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this.$container.css("display","none"),this._bindEvents(),this.activate(),this._container},onRemove:function(){this.map.off("layeradd",this._onLayerAdded),this.map.off("click",this._onMapClick),this.deactivate()},_bindEvents:function(){this._onLayerAdded=$.proxy(this.onLayerAdded,this),this._onLayerRemoved=$.proxy(this.onLayerRemoved,this),this._onMapClick=$.proxy(this.onMapClick,this),this.map.on("layeradd",this._onLayerAdded),this.map.on("layerremove",this._onLayerRemoved),this.map.on("click",this._onMapClick)},onMapClick:function(){this._selectedFeatures=[]},_vectorLayers:[],onLayerAdded:function(e){var t=this,i=e.layer,a=i.hasOwnProperty("_layers");a&&i.on&&(i.on("load",function(){var e=function(e){e.options=e.options||{},e.options.layerId=i.options.layerId,e.off("click",t._onFeatureClick),e.on("click",t._onFeatureClick)};this.eachLayer&&this.eachLayer(e),this.off("dblclick",t._onFeatureClick).on("dblclick",t._onFeatureClick)}),this._vectorLayers.push(i))},onLayerRemoved:function(e){if(e.layer.options&&e.layer.options.layerId){var t=e.layer.options.layerId;if(t&&e.layer._layers){var i=$.inArray(e.layer,this._vectorLayers);i>-1&&this._vectorLayers.splice(i,1)}}},_layerFromFeature:function(e,t){var i=t._layers;for(var a in i){var r=i[a];if(r.feature&&r.feature.id===e.id)return r}return null},unselect:function(e){var t=e.layerId,i=smap.cmd.getLayer(t),a=$.inArray(e,this._selectedFeatures);this._selectedFeatures.splice(a,1);var r=utils.getLayerFromFeature(e,i)||i;i.resetStyle.call(i,r),this._map.fire("unselected",{feature:e})},onFeatureClick:function(e){if(!this._active)return!1;var t=e.layer&&e.layer.feature?e.layer.feature:e.target.feature||e.target,i=e.originalEvent?e.originalEvent.shiftKey||!1:!1,a=e.target,r=a.options.layerId||e.layer.options.layerId,s=smap.core.layerInst._getLayer(r);if(i===!1&&(this._selectedFeatures=[],s&&s.resetStyle)){var n=s.resetStyle;s.eachLayer(function(e){n.call(s,e)});for(var o=this._vectorLayers,l=0,c=o.length;c>l;l++)h=o[l],h.resetStyle&&h!==s&&h.resetStyle(h)}var y=$.inArray(t,this._selectedFeatures);if(i===!0&&y>-1){this._selectedFeatures.splice(y,1),this._map.fire("unselected",{feature:t});var h=this._layerFromFeature(t,s);s.resetStyle.call(s,h)}else{if(t.layerId=r,t.uniqueKey=s&&s.options?s.options.uniqueKey:t.layerId,this._selectedFeatures.push(t),s){var d=this._layerFromFeature(t,s);d&&d.setStyle&&d.setStyle(s.options.selectStyle||this.options.selectStyle)}this._map.fire("selected",{feature:t,selectedFeatures:this._selectedFeatures,layer:s||t,latLng:e.latlng,shiftKeyWasPressed:e.originalEvent?e.originalEvent.shiftKey||!1:!1})}}}),L.control.selectVector=function(e){return new L.Control.SelectVector(e)};
L.Control.SelectWMS=L.Control.extend({options:{wmsVersion:"1.3.0",outputFormat:"GML2",info_format:"text/plain",maxFeatures:20,buffer:10,useProxy:!1},_layers:[],_selectedFeatures:[],initialize:function(t){L.setOptions(this,t)},onAdd:function(t){return this.map=t,this.activate(),this._container=L.DomUtil.create("div","leaflet-control-selectwms"),$(this._container).css("display","none"),L.DomEvent.disableClickPropagation(this._container),this._container},onRemove:function(){this.deactivate()},onSuccess:function(t){t=t||[];for(var e,s,i,n,a,r,o,l,c=0,p=t.length;p>c;c++)if(e=t[c],r=e[0],o=e[1],l=o.params,s=r.features,r)if(r.features){var i,n,a,s=r.features;if(!s.length)continue;for(var h=0,u=s.length;u>h;h++){if(i=s[h],i.latLng=o.latLng,n=smap.cmd.getLayerConfigBy("options.layers",l.layers)||smap.cmd.getLayerConfigBy("options.selectOptions.layers",l.layers),!n&&i.id){var f=i.id.split(".")[0];if(l.layers.search(f)>-1)for(var y=l.layers.split(","),m=0,d=y.length;d>m;m++)if(y[m].search(f)>-1){var _=y[m];n=smap.cmd.getLayerConfigBy("options.layers",_)||smap.cmd.getLayerConfigBy("options.selectOptions.layers",_)}}if(!n)break;a=n.options,a.selectOptions&&a.selectOptions.srs&&"EPSG:4326"!==a.selectOptions.srs&&utils.projectFeature(i,a.selectOptions.srs,{}),i.options=$.extend({},a)}this._selectedFeatures=this._selectedFeatures.concat(s)}else{var g,v,L=o.latLng;for(var x in r){g=r[x];var b=x.split(":"),S=b[b.length-1],n=smap.cmd.getLayerConfigBy("layers",S,{inText:!0});if(n&&n.options&&n.options.layerId)for(var O=n.options.layerId,h=0,u=g.length;u>h;h++){v=g[h];var i={geometry:{coordinates:[L.lng,L.lat]},latLng:L,properties:v,layerId:O,options:n.options};v&&$.isEmptyObject(v)===!1&&this._selectedFeatures.push(i)}}}this._selectedFeatures.length&&this.map.fire("selected",{layer:this,feature:this._selectedFeatures.length?this._selectedFeatures[0]:null,selectedFeatures:this._selectedFeatures})},_applyParam:function(t){var e,s,i,n,a,r=JSON.parse(decodeURIComponent(t)),o=[];for(s in r)i=r[s],i.xy&&(e=smap.core.layerInst.showLayer(s),o.push(e));n=i.xy&&i.xy.length?i.xy[0]:null,n&&(a=L.latLng(n[1],n[0]),this.onMapClick({latlng:a,_layers:o}))},onApplyParams:function(t,e){e.SEL&&this._applyParam(decodeURIComponent(e.SEL))},activate:function(){return this._active?!1:(this._active=!0,void this._bindEvents())},deactivate:function(){this._active=!1,this._unbindEvents()},_bindEvents:function(){this._onApplyParams=this._onApplyParams||$.proxy(this.onApplyParams,this),smap.event.on("smap.core.applyparams",this._onApplyParams),this.map.on("layeradd",this.onLayerAdd,this).on("layerremove",this.onLayerRemove,this).on("click",this.onMapClick,this).on("dblclick",this.onMapDblClick,this)},_unbindEvents:function(){smap.event.off("smap.core.applyparams",this._onApplyParams),this.map.off("layeradd",this.onLayerAdd,this).off("layerremove",this.onLayerRemove,this).off("click",this.onMapClick,this).off("dblclick",this.onMapDblClick,this)},onLayerAdd:function(t){var e=t.layer;this._layerShouldBeAdded(e)===!0&&this._layers.push(e)},onLayerRemove:function(t){var e=t.layer,s=this._hasLayer(e);s!==!1&&this._layers.splice(s,1)},onMapDblClick:function(){this._dblclickWasRegistered=!0,this.xhr&&this.xhr.abort(),setTimeout($.proxy(function(){this._dblclickWasRegistered=!1},this),400)},onMapClick:function(t){this._selectedFeatures=[];var e=t.latlng;this.xhr&&this.xhr.abort();var s=t._layers||this._layers;if(s.length){var i,n,a,r,o,l=this,c={},p=0;$.each(s,function(t,e){if(o=e.options||{},n=e._url||e._wmsUrl,a=n.toUpperCase(),c[a]){var s=c[a].selectOptions||{},i=o.selectOptions||{},h=s.info_format||l.options.info_format;r=h&&i.info_format&&h!==i.info_format,r&&(a+="_1")}c[a]||(c[a]={layerNames:[],url:n,wmsVersion:e._wmsVersion,layerId:o.layerId,selectOptions:o.selectOptions||{}},p+=1),c[a].layerNames.push(o.selectOptions&&o.selectOptions.layers?o.selectOptions.layers:o.layers)});var h;setTimeout($.proxy(function(){if(this._dblclickWasRegistered===!0);else{var t=[];for(var s in c){i=c[s],h=this._makeParams({layers:i.layerNames.join(","),version:i._wmsVersion||this.options.wmsVersion,info_format:i.selectOptions.info_format||this.options.info_format,latLng:e,srs:i.selectOptions.srs||"EPSG:4326"},i.selectOptions),"text/plain"===h.info_format&&(h.version="1.1.1");var n=this.onSuccess;this.request(i.selectOptions.url||i.url,h,{onSuccess:function(e,s){p-=1,t.push([e,s]),0>=p&&n.call(this,t)},onError:function(){p-=1},layerId:i.layerId,latLng:e})}}},this),100)}},_layerShouldBeAdded:function(t){var e=t.wmsParams?!0:!1;return t.options&&t.options.selectable&&t.options.selectable===!0&&this._hasLayer(t)===!1&&e===!0?!0:!1},_hasLayer:function(t){for(var e=this._layers,s=0,i=e.length;i>s;s++)if(t===e[s])return s;return!1},_makeParams:function(t,e){e=e||{};var s=this.map.latLngToContainerPoint(t.latLng),i=this.map.getBounds(),n=i.toBBoxString();if(e.srs&&"EPSG:4326"!==t.srs){var a=i.getSouthWest(),r=i.getNorthEast();a=utils.projectLatLng(a,"EPSG:4326",t.srs,!1,!1),r=utils.projectLatLng(r,"EPSG:4326",t.srs,!1,!1),i=L.latLngBounds(a,r),n=i.toBBoxString()}if(e.reverseAxisBbox){var o=n.split(",");n=[o[1],o[0],o[3],o[2]].join(",")}var l=$.extend({},{service:"WMS",request:"GetFeatureInfo",version:this.options.version,bbox:n,layers:null,styles:"",typename:t.layers,query_layers:t.layers,info_format:t.info_format,feature_count:this.options.maxFeatures,x:utils.round(s.x),y:utils.round(s.y),buffer:this.options.buffer,width:utils.round(this.map.getSize().x),height:utils.round(this.map.getSize().y),srs:"EPSG:4326",exceptions:"application%2Fvnd.ogc.se_xml"},t);return delete l.latLng,l},_parseText:function(t){for(var e,s,i,n,a,r={},o={},l=t.split("\n"),c=0,p=l.length;p>c;c++)if(e=l[c],0!==$.trim(e).length)if(-1!==e.search("=")){if(s=e.split("="),s.length>2){var h=s.slice(1);i=h.join("=")}else i=s[1];i=$.trim(i);var u=/^[0-9.]+$/.test(i),f=i.split("."),y=f.length<=2&&f[0].length>0&&(1===f.length||2===f.length&&f[1].length>0);if(u===!0&&y){try{switch(f.length){case 1:n=parseInt(i);break;case 2:n=parseFloat(i)}}catch(m){}n&&isNaN(n)===!1&&(i=n)}o[$.trim(s[0])]=i}else{var d=e.search(/'/);if(d>-1){e=e.substring(d+1),d=e.search(/'/),a&&r[a]&&$.isEmptyObject(o)===!1&&(r[a].push($.extend({},o)),o={}),a=e.substring(0,d),r[a]||(r[a]=[]);continue}a&&r[a]&&$.isEmptyObject(o)===!1&&(r[a].push($.extend({},o)),o={})}return a&&r[a]&&$.isEmptyObject(o)===!1&&r[a].push($.extend({},o)),r},request:function(t,e,s){e=e||{},s=s||{};var i=null;this.options.useProxy?t=smap.config.ws.proxy+encodeURIComponent(t+"?"+$.param(e)):i=e,this.xhr=$.ajax({url:t,data:i,type:"GET",dataType:"text",context:this,success:function(t){var i,n=e.info_format;if("text/plain"===n)i=this._parseText(t);else{if("application/json"!==n)return!1;i=JSON.parse(t)}s.onSuccess.call(this,i,{latLng:s.latLng,map:this.map,context:this,params:e})},error:s.onError})},CLASS_NAME:"L.Control.SelectWMS"}),L.control.selectWMS=function(t){return new L.Control.SelectWMS(t)};
L.Control.ShareLink=L.Control.extend({options:{position:"bottomright",addToMenu:!1,maxLen:2083},_lang:{sv:{caption:"Länk till kartan",close:"Stäng",tooLong:"För lång länk",tooLongUrl:"Notera! Länken är för lång för att fungera i en del äldre webbläsare. Ta bort ett eller flera ritade objekt för att göra länken kortare."},en:{caption:"Share link",close:"Close",tooLong:"Too long link",tooLongUrl:"Note! The link may not work in some older browsers. Please remove one or more drawn features to make it shorter."}},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-ShareLink"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._createBtn(),this._container},activate:function(){function t(){s.find("input[type=text]").prop("disabled",!0),s.off("shown.bs.modal",t)}var n=this,o=smap.cmd.createParams(!0),i=$('<div class="form-group"><input type="text" class="form-control" placeholder="'+this.lang.caption+'"></div>'),a=i.find("input");a.val(o);var e=function(t){t.setSelectionRange?t.setSelectionRange(0,9999):$(t).select()};if(!this._$dialog){var l='<button type="button" class="btn btn-default" data-dismiss="modal">'+this.lang.close+"</button>";this._$dialog=utils.drawDialog(this.lang.caption,i,l),this._$dialog.attr("id","slink-modal"),a.on("tap click",function(){e(this)}),this._$dialog.on("shown.bs.modal",function(){e(a[0])}),this._$dialog.on("hide.bs.modal",function(){$(this).find("input[type=text]").blur()}),this._$dialog.on("hidden.bs.modal",function(){n._$dialog.empty().remove(),n._$dialog=null})}if(o.length>this.options.maxLen){var s=this._$dialog,r=smap.cmd.notify(this.lang.tooLongUrl,"warning",{parent:i.parent()});r.removeClass("map-alert"),s.find("input[type=text]").val(this.lang.tooLong),s.on("shown.bs.modal",t)}this._$dialog.modal("show")},_createBtn:function(){var t=this,n=$('<button id="smap-sharelink-btn" title="'+this.lang.caption+'" class="btn btn-default"><span class="fa fa-link"></span></button>');n.on("click touchstart",function(){return t.activate(),!1}),this.$container.append(n)},onRemove:function(){}}),L.control.sharePos=function(t){return new L.Control.SharePos(t)};
L.Control.SharePosition=L.Control.extend({options:{position:"bottomright",autoActivate:!1,wfsSource:"//xyz.malmo.se:8081/geoserver/wfs",wfsFeatureType:"sandbox:sharedpositions",wfsUri:"//www.malmo.se/sandbox/",useProxy:!0,maxAge:15,_refreshIntervalMs:1e4,_storeIntervalMs:1e4},_lang:{sv:{dTitle:"Dela position",dShare:"Dela!",yourName:"Ditt namn",stopSharing:"Sluta dela",btnCancel:"Avbryt"},en:{dTitle:"Share position",dShare:"Share!",yourName:"Your name",stopSharing:"Stop sharing",btnCancel:"Cancel"}},_setLang:function(t){t=t||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},deactivate:function(){this._stopRefresh(),$("#smap-share-btn").removeClass("btn-danger"),this.dialog.find("input").val(null),$("#smap-share-btn").hide(),this.map.removeLayer(this.layer)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-shareposition"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._drawGui(),this._bindEvents(),this._container},onRemove:function(t){t.stopLocate()},_drawGui:function(){var t=$('<button id="smap-share-btn" class="btn btn-default" type="button"><span class="fa fa-user"></span></button>');t.hide(),this.$container.append(t);var e=this;smap.event.on("smap.core.pluginsadded",function(){$(".leaflet-control-Geolocate").before(e.$container)});var n='<div class="form-group"><label>'+this.lang.yourName+'</label><input type="text" class="form-control" placeholder="'+this.lang.yourName+'"></input></div>',s=$('<button type="button" class="btn btn-default" data-dismiss="modal">'+this.lang.btnCancel+'</button><button type="button" class="btn btn-primary">'+this.lang.dShare+"</button>");this.dialog=utils.drawDialog(this.lang.dTitle,n,s)},_makeFilter:function(){var t=this.options.maxAge,e=new Date,n=e.getTime(),s=n-60*t*1e3,a=new Date(s),o=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.GREATER_THAN,property:"datetime_changed",value:a}),i=new OpenLayers.Format.Filter({version:"1.1.0"}),r=new OpenLayers.Format.XML,l=r.write(i.write(o));return l},_addLayer:function(){var t=this;this.layer=smap.core.layerInst._createLayer({init:"L.GeoJSON.WFS",url:this.options.wfsSource,options:{noBindZoom:!0,noBindDrag:!0,layerId:"_shareposition",displayName:"Shared locations",featureType:this.options.wfsFeatureType,attribution:"Malmö stads WFS",inputCrs:"EPSG:4326",selectable:!0,popup:'<span><strong>${text_username}</strong>&nbsp;&nbsp;(<span style="white-space:nowrap;">${function(p) {var d = new Date(p.datetime_changed);var dNow = new Date(); var dDiff = new Date( Math.abs(dNow.getTime() - d.getTime()) ); return dDiff.getMinutes(); }}</span> min ago)</span>',hoverColor:"#FF0",zIndex:350,reverseAxis:!1,reverseAxisBbox:!0,uniqueKey:"id",params:{typeName:"sandbox:sharedpositions",version:"1.1.0",maxFeatures:1e4,format:"text/geojson",outputFormat:"json"}}}),this.layer.options.params.filter=this._makeFilter(),this.layer.off("load"),this.layer.on("load",function(){t.layer.eachLayer(function(e){var n=L.userMarker(e.getLatLng(),{pulsing:!0,smallIcon:!0});if(t.layer.removeLayer(e),e.feature){var s=parseInt(e.feature.id.split(".")[1]),a=t.uid||localStorage.share_uid||null;a=parseInt(a),(!a||a&&a!==s)&&t.layer.addLayer(n);var o=utils.extractToHtml(t.layer.options.popup,e.feature.properties);n.bindLabel(o,{noHide:!0,direction:"right"}).showLabel()}}),smap.cmd.loading(!1)}),this.map.addLayer(this.layer);var t=this},_bindEvents:function(){var t=this;smap.event.on("smap.core.pluginsadded",function(){$("#smap-glocate-btn").on("click",function(){return $(this).hasClass("btn-primary")?($("#smap-share-btn").show(),t._addLayer(),t._startRefresh()):(t._stopShare(),t.deactivate()),!1}),$("#smap-share-btn").on("click",function(){var e=$(this).hasClass("btn-danger");e?($(this).removeClass("btn-danger"),t._stopShare()):t.dialog.modal("show")})}),this.dialog.find("input").on("click",function(){$(this).focus()}),this.dialog.find(".modal-footer .btn-primary").on("click",function(){$("#smap-share-btn").addClass("btn-danger"),t.dialog.modal("hide");var e=$.trim(t.dialog.find("input[type='text']").val());t._startShare(e)})},_onLocationFound:function(t){this._location=t},_onLocationError:function(){smap.cmd.loading(!1)},_setLocateSettings:function(){var t={watch:!0,timeout:3e4,enableHighAccuracy:!0,frequency:3e3};$.extend(this.map._locateOptions,t)},_startShare:function(t){return this._storeInterval?!1:(utils.log("START sharing"),this.uName=t,this.__onLocationFound=this.__onLocationFound||$.proxy(this._onLocationFound,this),this.__onLocationError=this.__onLocationError||$.proxy(this._onLocationError,this),this.map.on("locationfound",this.__onLocationFound),this.map.on("locationerror",this.__onLocationFound),this.uid=localStorage.share_uid||null,this.__store=this.__store||$.proxy(this._store,this),this._storeInterval=setInterval(this.__store,this.options._storeIntervalMs),this._setLocateSettings(),void this.map.fire("drag"))},_startRefresh:function(){return this._refreshInterval?!1:(utils.log("start refreshing"),this.__refresh=this.__refresh||$.proxy(this._refresh,this),void(this._refreshInterval=setInterval(this.__refresh,this.options._refreshIntervalMs)))},_stopRefresh:function(){utils.log("stop refreshing"),clearInterval(this._refreshInterval),this._refreshInterval=null},_stopShare:function(){smap.cmd.loading(!1),utils.log("stop sharing"),this._stopRefresh(),clearInterval(this._storeInterval),this._storeInterval=null,this.map.off("locationfound",this.__onLocationFound,this),this.map.off("locationerror",this.__onLocationError,this),this._location=null,this.uid=null,this.uName=null},uid:null,_store:function(){return this._working||!this._location?!1:(this._working=!0,void $.ajax({url:this.options.useProxy?smap.config.ws.proxy+encodeURIComponent(this.options.wfsSource):this.options.wfsSource,type:"POST",context:this,data:this._getXml(this._location.latlng,this._location.accuracy,this.uName,this.uid),contentType:"text/xml",dataType:"text",error:function(t,e){utils.log("SharePosition: Error storing coordinates because of: "+e)},success:function(t){var e=$.xml2json(t),n=e?e.TransactionResponse||e["wfs:TransactionResponse"]:null;if(n){var s=n?n.TransactionSummary||n["wfs:TransactionSummary"]:null;if(s){var a=parseInt(s.totalInserted||s["wfs:totalInserted"]),o=parseInt(s.totalUpdated||s["wfs:totalUpdated"]);if(!this.uid&&a>0){var i=n.InsertResults||n["wfs:InsertResults"],r=i.Feature||i["wfs:Feature"],l=r.FeatureId||r["ogc:FeatureId"],h=l.fid||l.$.fid;this.uid=parseInt(h.split(".")[1]),localStorage.share_uid=this.uid}else 0===a&&0===o&&(this.uid=null,delete localStorage.share_uid)}}},complete:function(){this._working=!1}}))},_refresh:function(){this.layer.options.params.filter=this._makeFilter(),this.layer._refresh(!0)},_getXml:function(t,e,n,s){var a="",o=this.options.wfsFeatureType.split(":")[1];return a=s?'<wfs:Transaction\n  service="WFS"\n  version="1.1.0"\n  xmlns:grp="'+this.options.wfsUri+'"\n  xmlns:wfs="//www.opengis.net/wfs"\n  xmlns:ogc="//www.opengis.net/ogc"\n  xmlns:gml="//www.opengis.net/gml"\n  xmlns:xsi="//www.w3.org/2001/XMLSchema-instance"\n  xsi:schemaLocation="//www.opengis.net/wfs\n                      //schemas.opengis.net/wfs/1.1.0/WFS-transaction.xsd">\n  <wfs:Update typeName="grp:'+o+'">\n	 <wfs:Property><wfs:Name>text_username</wfs:Name><wfs:Value>'+n+"</wfs:Value></wfs:Property>	 <wfs:Property><wfs:Name>int_accuracy</wfs:Name><wfs:Value>"+e+'</wfs:Value></wfs:Property>    <wfs:Property>\n      <wfs:Name>the_geom</wfs:Name>\n      <wfs:Value>\n        <gml:Point srsDimension="2" srsName="urn:x-ogc:def:crs:EPSG:4326">\n          <gml:coordinates decimal="." cs="," ts=" ">'+t.lat+","+t.lng+"</gml:coordinates>\n        </gml:Point>\n      </wfs:Value>\n    </wfs:Property>\n    <ogc:Filter>\n      <PropertyIsEqualTo>\n        <PropertyName>id</PropertyName>\n        <Literal>"+s+"</Literal>\n      </PropertyIsEqualTo>\n    </ogc:Filter>\n  </wfs:Update>\n</wfs:Transaction>":'<wfs:Transaction\n  service="WFS"\n  version="1.1.0"\n  xmlns:grp="'+this.options.wfsUri+'"\n  xmlns:wfs="//www.opengis.net/wfs"\n  xmlns:gml="//www.opengis.net/gml"\n  xmlns:xsi="//www.w3.org/2001/XMLSchema-instance"\n  xsi:schemaLocation="//www.opengis.net/wfs\n                      //schemas.opengis.net/wfs/1.1.0/WFS-transaction.xsd\n                      '+this.options.wfsSource+"/DescribeFeatureType?typename="+this.options.wfsFeatureType+'">\n  <wfs:Insert>\n    <grp:'+o+'>\n      <grp:the_geom>\n        <gml:Point srsDimension="2" srsName="urn:x-ogc:def:crs:EPSG:4326">\n          <gml:coordinates decimal="." cs="," ts=" ">'+t.lat+","+t.lng+"</gml:coordinates>\n        </gml:Point>\n      </grp:the_geom>\n      <grp:int_accuracy>"+e+"</grp:int_accuracy>\n      <grp:text_username>"+n+"</grp:text_username>\n    </grp:"+o+">\n  </wfs:Insert>\n  </wfs:Transaction>"}}),L.control.sharePosition=function(t){return new L.Control.SharePosition(t)};
L.Control.ShareTweet=L.Control.extend({options:{position:"topright",wfsSource:"//localhost:8080/geoserver/wfs",wfsFeatureType:"local:tweets"},_lang:{sv:{btnAdd:"Lägg till",btnUnshare:"Sluta dela position",titleDialog:"Skriv nånting",btnCancel:"Avbryt",btnSubmit:"Skicka",loading:"Arbetar..."},en:{btnAdd:"Add tweet",btnUnshare:"Stop sharing position",titleDialog:"Write something",btnCancel:"Cancel",btnSubmit:"Submit",loading:"Working..."}},_setLang:function(t){t=t||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},onAdd:function(t){this.map=t,this._container=L.DomUtil.create("div","leaflet-control-sharetweet"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._drawBtn(),this._addWfsLayer();var n=this;return this.map.on("zoomend moveend",function(){n.layer._refresh()}),this._container},onRemove:function(){},_notify:function(t,n){switch(n){case"success":n="alert-success";break;case"error":n="alert-danger"}var e=$('<div class="alert '+n+' alert-dismissable"> <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'+t+"</div>");e.css({"margin-top":"20px"}),$(".modal-body").find(".alert").remove(),$(".modal-body .sharetweet-footer").before(e)},_addWfsLayer:function(){this.cluster=new L.MarkerClusterGroup,this.layer=smap.core.layerInst._createLayer({init:"L.GeoJSON.WFS",url:this.options.wfsSource,options:{layerId:"sharetweet-wfstlayer",displayName:"Tweets",featureType:this.options.wfsFeatureType,attribution:"Malmö stads WFS",inputCrs:"EPSG:4326",reverseAxis:!0,selectable:!0,popup:'<p class="lead">${text_text}</p><p>Skrivet den: <strong>${function(p) {var d = new Date(p.dtime_created);return d.toLocaleString();}}</strong></p>',uniqueAttr:null,hoverColor:"#FF0",style:{weight:6,color:"#F00",dashArray:"",fillOpacity:.5}}});var t=this;this.layer._map=this.map,this.layer.on("load",function(n){n.layer.eachLayer(function(n){t.cluster.addLayer(n)}),n.layer.clearLayers(),t.map.removeLayer(t.cluster),t.map.addLayer(t.cluster),smap.cmd.loading(!1)}),this.map.addLayer(this.cluster)},_onLocationFound:function(t){smap.cmd.loading(!1);var n=6;this.modal&&(this.modal.find('form td[name="easting"]').empty().text(utils.round(t.latlng.lng,n)),this.modal.find('form td[name="northing"]').empty().text(utils.round(t.latlng.lat,n)),this.modal.find('form td[name="accuracy"]').empty().text(utils.round(t.accuracy,1)+" m"),this.modal.find(".btn-primary").button("reset"))},_onLocationError:function(){var t=this;this._notify("Your position could not be determined","error"),setTimeout(function(){t.deactivate()},3e3)},deactivate:function(){this.modal&&this.modal.modal("hide")},shareTweet:function(){$("#sharetweet-btn").button(this.lang.btnUnshare),smap.cmd.loading(!0),this.modal=this._showDialog(),this.modal.find(".btn-primary").button("loading");var t=smap.cmd.getControl("Geolocate");t&&t.deactivate(),this.map.on("locationfound",$.proxy(this._onLocationFound,this)),this.map.on("locationerror",$.proxy(this._onLocationError,this)),this.map.locate({watch:!0,setView:!0,enableHighAccuracy:!0}),smap.cmd.loading(!1)},unShareTweet:function(){$("#sharetweet-btn").button(this.lang.btnAdd),this.map.off("locationfound",$.proxy(this._onLocationFound,this)),this.map.off("locationerror",$.proxy(this._onLocationError,this))},_showDialog:function(){var t=$('<form id="sharetweet-form" role="form"><textarea class="form-control" rows="4" name="text" minlength="5" maxlength="140" required></textarea><table><tr><td>Easting:</td><td name="easting"></td></tr><tr><td>Northing:</td><td name="northing"></td></tr><tr style="font-weight:bold;"><td>Felmarginal:</td><td name="accuracy"></td></tr></table><div class="row sharetweet-footer"><button type="button" class="btn btn-default" data-dismiss="modal">'+this.lang.btnCancel+'</button><button type="submit" class="btn btn-primary" data-loading-text="'+this.lang.loading+'">'+this.lang.btnSubmit+"</button></div></form>"),n=this;t.on("submit",function(){var t=$(this).serializeArray(),e={};return $.each(t,function(t,n){e[n.name]=n.value}),e.easting=parseFloat($(this).find('[name="easting"]').text()),e.northing=parseFloat($(this).find('[name="northing"]').text()),n._save(L.latLng(e.northing,e.easting),e.text),!1}),t.find("tr").each(function(){var t=$(this).find("td:eq(1)");t.text(""),n._addSpin(t)});var e=utils.drawDialog(this.lang.titleDialog,t,null,{size:"sm"});return t.find(".btn-default").on("click",function(){return e.modal("hide"),!1}).find(".btn-primary").on("click",function(){return!1}),e.modal("show"),e.on("hidden.bs.modal",function(){n.map.stopLocate(),n.modal.empty().remove(),n.modal=null,$("#sharetweet-btn").button(this.lang.btnAdd),$("#sharetweet-btn").removeClass("btn-primary"),delete n.modal}),e},_addSpin:function(t){var n={length:5,width:1,radius:3},e=new Spinner(n).spin();$(t).append(e.el)},_drawBtn:function(){var t=this,n=$('<button id="sharetweet-btn" class="btn btn-default btn-lg"><span class="glyphicon glyphicon-map-marker"></span>&nbsp;&nbsp;<span>'+this.lang.btnAdd+"</span></button>");n.on("click",function(){$(this).hasClass("btn-primary")?($(this).removeClass("btn-primary"),t.unShareTweet()):($(this).addClass("btn-primary"),t.shareTweet())}),this.$container.append(n)},_createRequest:function(t,n){var e='<wfs:Transaction\n  service="WFS"\n  version="1.1.0"\n  xmlns:grp="//localhost/"\n  xmlns:wfs="//www.opengis.net/wfs"\n  xmlns:gml="//www.opengis.net/gml"\n  xmlns:xsi="//www.w3.org/2001/XMLSchema-instance"\n  xsi:schemaLocation="//www.opengis.net/wfs\n                      //schemas.opengis.net/wfs/1.1.0/WFS-transaction.xsd\n                      '+this.options.wfsSource+"/DescribeFeatureType?typename="+this.options.wfsFeatureType+'">\n  <wfs:Insert>\n    <grp:tweets>\n      <grp:text_text>'+n.text+'</grp:text_text>\n      <grp:the_geom>\n        <gml:Point srsDimension="2" srsName="urn:x-ogc:def:crs:EPSG:4326">\n          <gml:coordinates decimal="." cs="," ts=" ">'+t.lat+","+t.lng+"</gml:coordinates>\n        </gml:Point>\n      </grp:the_geom>\n    </grp:tweets>\n  </wfs:Insert>\n</wfs:Transaction>";return e},_save:function(t,n){if(this.submitting)return!1;this.map.stopLocate(),this.submitting=!0,smap.cmd.loading(!0),this.modal.find(".btn-primary").button("loading");var e=this._createRequest(t,{text:n});$.ajax({url:smap.config.ws.proxy+encodeURIComponent(this.options.wfsSource),type:"POST",context:this,data:e,contentType:"text/xml",dataType:"text",success:function(t){smap.cmd.loading(!1);var n=$.xml2json(t);parseInt(n.TransactionSummary.totalInserted)>0&&(this.deactivate(),this._reload())},error:function(t,n){this._notify("Kunde inte spara. Fel: <strong>"+n+"</strong>","error"),smap.cmd.loading(!1)},complete:function(){this.modal.find(".btn-primary").button("reset"),this.submitting=!1}})},_reload:function(t){t=t||{},smap.cmd.loading(!0),this.layer._refresh()}}),L.control.shareTweet=function(t){return new L.Control.ShareTweet(t)};
L.Control.ToolHandler=L.Control.extend({options:{position:"bottomright",showPopoverTitle:!1},_lang:{sv:{popoverTitle:"Verktyg"},en:{popoverTitle:"Tools"}},_setLang:function(n){n=n||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[n]:null)},initialize:function(n){L.setOptions(this,n),this._setLang(n.langCode)},onAdd:function(){var n=this;return n._container=L.DomUtil.create("div","leaflet-control-toolhandler"),L.DomEvent.disableClickPropagation(n._container),n.$container=$(n._container),n.$container.css("display","none"),this._makeToolHandler(),smap.event.on("smap.core.pluginsadded",function(){$(".thandler-container .leaflet-control button").each(function(){$(this).tooltip({placement:"bottom",container:"#maindiv"})})}),n._container},activate:function(){},_makeToolHandler:function(){function n(n){var o=$(".thandler-popover").length&&parseInt($(".thandler-popover").css("opacity")||0)>0,t=$(".popover-content");a.data("bs.popover")&&o&&t.children().length&&(utils.getBrowser().ie9&&r(),a.popover("hide")),smap.event.trigger("smap.toolhandler.hide",n)}function o(){var n=$(".thandler-container").children(":has('button')");n.length&&a.popover("show")}var t=this,e=$(".leaflet-top.leaflet-right");this.$thCont=e,e.addClass("thandler-container");var a=$('<div class="thandler-btn popover-dismiss"><button type="button" class="btn btn-default thbtn"><span class="fa fa-th"></span></button></div>');$("#mapdiv").append(a),this._map.on("click dragstart",n),$(window).on("orientationchange",n);var r=function(){$(window).off("resize",n);var o=$(".popover-content");setTimeout(function(){$(".thandler-container").append(o.children())},150)};a.on("click",function(){var e=$(this);if(e.data("bs.popover")){var a=$(".thandler-popover").length&&parseInt($(".thandler-popover").css("opacity")||0)>0;if(a)return utils.getBrowser().ie9&&r(),e.popover("hide"),!1}else e.popover({content:null,placement:"bottom",title:t.lang.popoverTitle,trigger:"manual"}),e.on("shown.bs.popover",function(){var o=$(".popover"),e=$(".popover-content");t.options.showPopoverTitle||o.find("h3").remove(),o.addClass("thandler-popover");var a=$(".thandler-container").children(".leaflet-control:has('button')").detach();e.empty(),e.append(a),$(window).on("resize",n)}),e.on("hidden.bs.popover",r);return o(),!1}),a.on("tap",function(){return!1}),a.on("dblclick",function(){return!1})},onRemove:function(){}}),L.control.toolhandler=function(n){return new L.Control.ToolHandler(n)};
L.Control.Zoombar=L.Control.extend({options:{position:"bottomright"},_lang:{sv:{exampleLabel:"Ett exempel"},en:{exampleLabel:"An example"}},_setLang:function(n){n=n||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[n]:null)},initialize:function(n){L.setOptions(this,n),this._setLang(n.langCode)},onAdd:function(n){return this.map=n,this._container=L.DomUtil.create("div","leaflet-control-zoombar"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this.$container.addClass("btn-group-vertical"),this.$container.on("mousedown",function(){return!1}),this._createButtonZoomIn(),this._createButtonZoomUt(),this.__onZoomEnd=this.__onZoomEnd||$.proxy(this._onZoomEnd,this),this.map.on("zoomend",this.__onZoomEnd),this._container},_onZoomEnd:function(){this.map.getZoom()>=this.map.getMaxZoom()?this.$container.find("#zoombar-plus").addClass("disabled"):this.map.getZoom()<=this.map.getMinZoom()?this.$container.find("#zoombar-minus").addClass("disabled"):this.$container.find("button").removeClass("disabled")},_createButtonZoomIn:function(){var n=$('<button id="zoombar-plus" class="btn btn-default"><span class="fa fa-plus"></span></button>');this.$container.append(n);n.on("click touchstart dblclick",function(){return smap.map.zoomIn(),!1})},_createButtonZoomUt:function(){var n=$('<button id="zoombar-minus" class="btn btn-default"><span class="fa fa-minus"></span></button>');this.$container.append(n);n.on("click touchstart dblclick",function(){return smap.map.zoomOut(),!1})},onRemove:function(){}}),L.control.zoombar=function(n){return new L.Control.Zoombar(n)};